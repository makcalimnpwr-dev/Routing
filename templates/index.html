<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>İnteraktif Planlama Aracı</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
            flex-direction: row;
        }

        #sidebar {
            width: 350px;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #main-content {
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #right-sidebar {
            width: 400px;
            padding: 15px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
            height: 100vh;
        }

        #top-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        #filter-bar {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        #summary-bar {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
            font-size: 13px;
            width: 300px;
        }

        .summary-item {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span {
            font-weight: bold;
            color: #0056b3;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .filter-item select {
            min-width: 150px;
            padding: 5px;
        }

        .schedule-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            padding: 10px;
        }

        .schedule-item {
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 8px 8px 20px;
            border-bottom: 1px solid #eee;
            background-color: white;
            cursor: pointer;
        }

        .date-group-header {
            font-size: 14px;
            padding: 10px 8px;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-radius: 5px;
        }

        .empty-date-group-header {
            background-color: #6c757d !important;
            font-size: 14px;
            padding: 10px 8px;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-radius: 5px;
        }

        .header-buttons {
            display: flex;
            gap: 5px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .header-btn {
            font-size: 10px;
            padding: 2px 5px;
            cursor: pointer;
            color: black;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .empty-btn {
            background-color: #6c757d;
            color: white;
        }

        .leaflet-popup-content {
            min-width: 280px;
        }

        .popup-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            font-size: 12px;
        }

        .popup-info-grid span,
        .popup-info-grid div {
            display: flex;
            flex-direction: column;
        }

        .popup-info-grid input {
            font-size: 12px;
            padding: 2px;
        }

        .address-info {
            font-style: italic;
            color: #555;
            margin-top: 5px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        .popup-date-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .popup-date-list li:last-child {
            border-bottom: none;
        }

        .order-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .popup-order-input {
            width: 40px;
            padding: 2px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .delete-date {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .delete-date:hover {
            background-color: #c82333;
        }

        .popup-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .save-load-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .save-load-controls button {
            flex-grow: 1;
            padding: 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        #savePlanBtn {
            background-color: #28a745;
            color: white;
        }

        #clearPlanBtn {
            background-color: #dc3545;
            color: white;
        }

        .merch-icon-container {
            position: relative;
            width: 25px;
            height: 41px;
        }

        .merch-icon-container img {
            width: 100%;
            height: 100%;
        }

        .merch-number {
            position: absolute;
            top: 6px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px black, -1px -1px 2px black, 1px -1px 2px black, -1px 1px 2px black;
        }

        .store-name-label {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
            display: none;
        }

        .schedule-item.frequency-warning {
            background-color: #ff0000 !important;
            color: white !important;
        }

        .schedule-item.frequency-low {
            background-color: #fff9c4 !important;
        }

        .delete-store-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 16px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            margin-left: auto;
            padding-right: 1px;
        }

        .delete-store-btn:hover {
            background-color: #c82333;
        }

        .section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        #toggleNamesBtn {
            width: 100%;
            padding: 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* YENİ: Mağaza isimlerini göster butonu */
        #toggleStoreNamesBtn {
            width: 100%;
            padding: 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* YENİ: Frekansları göster butonu */
        #toggleFrequencyBtn {
            width: 100%;
            padding: 10px;
            background-color: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .bulk-assign-controls,
        .free-route-controls {
            display: block;
            margin-top: 10px;
        }

        .bulk-assign-controls input,
        .bulk-assign-controls select,
        .free-route-controls input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .bulk-assign-controls button,
        .free-route-controls button {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .selection-mode-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #856404;
        }

        .rectangle-draw-instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }

        /* YENİ: Tarih çubukları için stil */
        .date-bars-container {
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 4px;
            display: flex;
            gap: 1px;
            padding: 0 2px;
        }

        .date-bar {
            flex: 1;
            height: 100%;
            border-radius: 1px;
            max-width: 10px;
        }

        .date-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            margin-bottom: 5px;
        }

        .date-bars-wrapper {
            position: relative;
        }

        .date-bars-wrapper:hover .date-tooltip {
            display: block;
        }

        /* YENİ: Arama filtreleri için stil */
        .search-filter-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .search-filter-item label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .search-filter-item input,
        .search-filter-item select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .clear-filter-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 3px;
        }

        .clear-filter-btn:hover {
            background-color: #5a6268;
        }

        /* YENİ: Ekle butonu ve modal için stiller */
        #addStoreBtn {
            width: 100%;
            padding: 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .modal-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }

        .modal-tab.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #saveSingleStoreBtn {
            background-color: #28a745;
            color: white;
        }

        #uploadStoresBtn {
            background-color: #17a2b8;
            color: white;
        }

        /* YENİ: Büyük soru işareti ikonu */
        .question-mark-icon {
            background-color: #ffc107;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* YENİ: Minimum gün aralığı kontrolü için stil */
        .frequency-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .frequency-control label {
            font-weight: bold;
            margin-bottom: 0;
            white-space: nowrap;
        }

        .frequency-control input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
        }

        /* YENİ: Mağaza ismi etiketleri için stil */
        .store-name-tooltip {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        /* YENİ: Yeni eklenen mağaza için özel stil */
        .new-store-marker {
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.7) !important;
        }

        /* YENİ: Özel marker ikonları için stil */
        .custom-marker-icon {
            background: transparent !important;
            border: none !important;
            position: relative;
        }

        .custom-marker-svg {
            width: 25px;
            height: 41px;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));
        }

        /* YENİ: Seçili mağaza için stil (daha belirgin) */
        .custom-marker-icon.selected-store::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 55%;
            transform: translate(-50%, -50%);
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 3px solid rgba(255, 251, 0, 0.95);
            background: rgba(255, 255, 255, 0.10);
            box-shadow:
                0 0 14px rgba(255, 251, 0, 0.9),
                0 0 10px rgba(255, 0, 0, 0.75);
            pointer-events: none;
        }

        .custom-marker-icon.selected-store .custom-marker-svg {
            filter:
                drop-shadow(0 0 10px rgba(255, 251, 0, 0.9)) drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));
        }

        .question-mark-icon.selected-store {
            border: 3px solid rgba(255, 251, 0, 0.95) !important;
            box-shadow: 0 0 14px rgba(255, 251, 0, 0.9), 0 0 10px rgba(255, 0, 0, 0.75) !important;
            border-radius: 50%;
        }

        /* YENİ: Otomatik sıralama butonu için stil */
        #autoSortAllDaysBtn {
            width: 100%;
            padding: 12px;
            background-color: #6610f2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #autoSortAllDaysBtn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .progress-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #0c5460;
        }

        /* İMZA STİLİ */
        #watermark {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 2000;
            font-size: 14px;
            color: #808080;
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
            opacity: 0.8;
        }

        /* SERVER BAĞLANTI MODALI CSS */
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #dc3545;
            /* Varsayılan Kırmızı */
            display: inline-block;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease;
        }

        .status-indicator.connected {
            background-color: #28a745;
            /* Yeşil */
            box-shadow: 0 0 8px #28a745;
        }

        .server-status-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        #serverSettingsBtn i {
            margin-right: 5px;
        }

        /* YENİ: Excel yükleme alanı - daha profesyonel görünüm */
        .excel-upload-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .excel-upload-title {
            font-weight: 700;
            margin-bottom: 8px;
        }

        .excel-upload-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .excel-upload-file-btn {
            background: #0f172a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .excel-upload-file-btn:hover {
            background: #111c33;
        }

        .excel-upload-file-name {
            flex: 1;
            font-size: 12px;
            color: #475569;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .excel-upload-submit-btn {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-weight: 700;
            white-space: nowrap;
        }

        .excel-upload-submit-btn:hover {
            background: #1d4ed8;
        }

        /* YENİ: Ctrl serbest rota popup butonları */
        .leaflet-popup.ctrl-route-popup {
            pointer-events: none;
            /* büyük boş alan tıklamayı engellemesin */
        }

        .leaflet-popup.ctrl-route-popup .leaflet-popup-content-wrapper {
            border-radius: 999px;
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
            display: inline-block;
        }

        .leaflet-popup.ctrl-route-popup .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
            min-width: 0 !important;
        }

        .leaflet-popup.ctrl-route-popup .leaflet-popup-tip-container {
            display: none;
        }

        .ctrl-route-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }

        .ctrl-route-btn {
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .ctrl-route-btn.primary {
            background: #16a34a;
            color: #fff;
        }

        .ctrl-route-btn.primary:hover {
            background: #15803d;
        }

        .ctrl-route-btn.danger {
            background: #ef4444;
            color: #fff;
        }

        .ctrl-route-btn.danger:hover {
            background: #dc2626;
        }

        .ctrl-route-btn.primary {
            padding: 10px 14px;
            font-size: 13px;
            border-radius: 999px;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
            white-space: nowrap;
            pointer-events: auto;
            /* buton tıklanabilir olsun */
        }

        /* Rota & Seçimi Temizle butonu (daha büyük ve aşağıda) */
        .clear-map-state-btn {
            margin-top: 14px !important;
            width: 100% !important;
            padding: 12px 12px !important;
            font-size: 14px !important;
            font-weight: 800 !important;
            background-color: #dc3545 !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
        }

        .clear-map-state-btn:hover {
            background-color: #c82333 !important;
        }

        .clear-map-state-btn--compact {
            width: auto !important;
            margin-top: 0 !important;
            padding: 10px 12px !important;
            font-size: 13px !important;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="section">
            <button id="openAutoRouteModalBtn"
                style="width: 100%; padding: 10px; background-color: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;">
                <i class="fas fa-magic"></i> Otomatik Rotala & Planla
            </button>
        </div>

        <div class="section">
            <button id="serverSettingsBtn"
                style="width: 100%; padding: 10px; background-color: #343a40; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="fas fa-server"></i> Server Ayarları
                <div id="sidebarStatusLight" class="status-indicator"></div>
            </button>
        </div>

        <div class="section">
            <a href="/personel_takip"
                style="width: 100%; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; font-weight: bold;">
                <i class="fas fa-user-check"></i> Personel Takip
            </a>
        </div>

        <!-- YENİ: PROJE YÖNETİMİ BÖLÜMÜ -->
        <div class="section">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Proje Yönetimi</h3>

            <button id="saveProjectBtn"
                style="width: 100%; padding: 8px; margin-bottom: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                <i class="fas fa-save"></i> Proje Kaydet
            </button>

            <div style="position: relative;">
                <button id="projectsMenuBtn"
                    style="width: 100%; padding: 8px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: space-between;">
                    <span><i class="fas fa-folder-open"></i> Projeler</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div id="projectsDropdown"
                    style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                    <div id="projectsList" style="padding: 5px;">
                        <div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Proje
                            yükleniyor...</div>
                    </div>
                </div>
            </div>

            <small style="display: block; color: #666; margin-top: 5px; font-size: 11px;">Farklı Excel dosyalarını proje
                olarak kaydedin</small>
        </div>

        <div class="section" style="padding-bottom: 10px; text-align: center;"><a href="/download_template"
                style="text-decoration: none; font-weight: bold; color: #28a745;">&raquo; Kalıbı İndir &laquo;</a></div>

        <div class="section">
            <button id="addStoreBtn">Mağaza Ekle</button>
        </div>

        <div class="section save-load-controls">
            <button id="savePlanBtn">Çalışmayı Kaydet</button>
            <button id="clearPlanBtn">Kaydı Temizle</button>
        </div>

        <div class="section">
            <button id="downloadFullPlanBtn"
                style="width: 100%; padding: 10px; font-size: 14px; background-color: #0d6efd; color: white;">Tam Planı
                İndir</button>
        </div>
        <div class="section">
            <button id="fixDayStoresBtn"
                style="width: 100%; padding: 10px; font-size: 14px; background-color: #fd7e14; color: white; font-weight: bold;">Günlerdeki
                Noktaları Sabitle</button>
            <small style="color: #666; display: block; margin-top: 5px;">Sapan mağazaları düzeltir ve en yakın
                mağazaları gruplar</small>
        </div>
        <div class="section">
            <div class="excel-upload-card">
                <div class="excel-upload-title">Excel Yükleyin</div>
                <form id="mainExcelUploadForm" method="post" enctype="multipart/form-data">
                    <input type="file" id="mainExcelFileInput" name="file" accept=".xlsx, .xls" style="display:none;">
                    <div class="excel-upload-row">
                        <label class="excel-upload-file-btn" for="mainExcelFileInput">Dosya Seç</label>
                        <div id="mainExcelFileName" class="excel-upload-file-name">Dosya seçilmedi</div>
                        <button type="submit" class="excel-upload-submit-btn">Haritada Göster</button>
                    </div>
                </form>
                {% if error %}<p class="error" style="margin-top:8px;">{{ error }}</p>{% endif %}
            </div>
        </div>

        <div class="section">
            <button id="autoSortAllDaysBtn">Tüm Günleri Otomatik Sırala</button>
            <div id="sortProgressInfo" class="progress-info" style="display: none;">
                <div>İşlem devam ediyor...</div>
                <div id="sortProgressText">Hazırlanıyor</div>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">Tüm günlerdeki mağazaları mesafeye göre
                otomatik sıralar</small>
        </div>

        <div class="section">
            <h3>Seçim Modları</h3>

            <div class="selection-mode-info" id="selectionModeInfo" style="display: none;">
                Mod aktif: <span id="currentModeText"></span>
            </div>

            <small style="display: block; color: #666; margin-bottom: 10px;"><strong>Kare Seçim:</strong> Shift tuşuna
                basılı tutarak haritada kare çizin</small>

            <div id="bulkAssignControls" class="bulk-assign-controls" style="display: block;">
                <input type="text" id="bulkDateInput" placeholder="Gün (1-28) / 1. Gün">
                <select id="bulkMerchInput">
                    <option value="">Personel Seçiniz</option>
                </select>
                <button id="bulkAssignBtn">Seçilenlere Ata</button>

                <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">
                <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">Belirli Gün
                    Sil:</label>
                <select id="bulkDeleteDateSelect">
                    <option value="">Seçim Yapılmadı</option>
                </select>
                <button id="bulkDeleteSpecificDateBtn" style="background-color: #dc3545; color: white;">Seçili Günü
                    Sil</button>

                <button id="bulkClearDatesBtn" style="background-color: #ffc107; margin-top: 5px;">Seçilenlerin TÜM
                    Günlerini Temizle</button>
                <small>
                    <p id="selectedCount">0 mağaza seçildi.</p>
                </small>
            </div>
        </div>

        <div class="section">
            <button id="toggleStoreNamesBtn">Mağaza İsimlerini Göster</button>
            <button id="toggleNamesBtn">Personel İsimlerini Göster</button>
            <button id="toggleFrequencyBtn">Frekansları Göster</button>
        </div>

        <div class="section">
            <h3>Serbest Rota Çizimi</h3>
            <small style="display:block; color:#666; line-height: 1.4;">
                <strong>Ctrl:</strong> Ctrl tuşuna basılı tutup haritada 2+ noktayı seçin. Son seçtiğiniz noktanın
                üzerinde <b>Seçimi Hesapla</b> butonu çıkar. <br>
                <strong>Esc:</strong> Seçili noktaları temizler.
            </small>
        </div>

    </div>

    <div id="main-content">
        <div id="map"></div>

        <div id="top-controls">
            <div id="filter-bar">
                <div class="filter-item">
                    <label for="regionFilter">Bölge Seç:</label>
                    <select id="regionFilter">
                        <option value="all">Tümü</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="dateFilter">Gün Seç:</label>
                    <select id="dateFilter">
                        <option value="all">Tümü</option>
                        <option value="empty_days">Boş Günler</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="merchFilter">Personel Seç:</label>
                    <select id="merchFilter">
                        <option value="all">Tümü</option>
                    </select>
                </div>

                <div class="search-filter-item">
                    <label for="storeSearchFilter">Mağaza Ara:</label>
                    <input type="text" id="storeSearchFilter" placeholder="Mağaza ismi yazın...">
                    <button class="clear-filter-btn" onclick="clearStoreFilter()">Temizle</button>
                </div>

                <div class="search-filter-item">
                    <label for="cityFilter">İl Seç:</label>
                    <select id="cityFilter">
                        <option value="all">Tümü</option>
                    </select>
                    <button class="clear-filter-btn" onclick="clearCityFilter()">Temizle</button>
                </div>

                <div class="search-filter-item">
                    <label for="districtFilter">İlçe Seç:</label>
                    <select id="districtFilter">
                        <option value="all">Tümü</option>
                    </select>
                    <button class="clear-filter-btn" onclick="clearDistrictFilter()">Temizle</button>
                </div>

                <div class="filter-item">
                    <label for="frequencyFilter">Frekans Filtresi:</label>
                    <select id="frequencyFilter">
                        <option value="all">Tümü</option>
                    </select>
                </div>
            </div>

            <div id="summary-bar">
            </div>
        </div>

        <div id="watermark">Created By M.Akcali</div>

    </div>

    <div id="right-sidebar">
        <div class="frequency-control">
            <label for="minDayInterval">Min. Gün Aralığı:</label>
            <input type="number" id="minDayInterval" min="1" max="30" value="13">
            <button onclick="applyFrequencyCheck()"
                style="padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">Uygula</button>
        </div>

        <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; margin-top: 10px;">
            <h3 style="margin: 0;">Atama Listesi</h3>
            <button id="clearMapStateBtn" class="clear-filter-btn clear-map-state-btn clear-map-state-btn--compact">Rota
                & Seçimi Temizle</button>
        </div>
        <div class="schedule-list-container" id="schedule-list">
            <p>Henüz atama yapılmadı.</p>
        </div>
    </div>

    <div id="addStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Mağaza Ekle</h3>
                <button class="close-modal">&times;</button>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="single">Tekli Mağaza Ekle</button>
                <button class="modal-tab" data-tab="multiple">Çoklu Mağaza Ekle</button>
            </div>

            <div id="single-tab" class="tab-content active">
                <div class="form-group">
                    <label for="storeName">Mağaza İsmi:</label>
                    <input type="text" id="storeName" placeholder="Mağaza ismini girin">
                </div>
                <div class="form-group">
                    <label for="storeLat">Enlem:</label>
                    <input type="text" id="storeLat" placeholder="Enlem değerini girin">
                </div>
                <div class="form-group">
                    <label for="storeLng">Boylam:</label>
                    <input type="text" id="storeLng" placeholder="Boylam değerini girin">
                </div>
                <div class="form-actions">
                    <button id="saveSingleStoreBtn">Kaydet</button>
                    <button id="cancelSingleStoreBtn" style="background-color: #6c757d; color: white;">İptal</button>
                </div>
            </div>

            <div id="multiple-tab" class="tab-content">
                <div class="form-group">
                    <label for="storeExcelFile">Excel Dosyası Seçin:</label>
                    <input type="file" id="storeExcelFile" accept=".xlsx, .xls">
                    <small style="color: #666; display: block; margin-top: 5px;">Excel dosyasında "Mağaza İsmi",
                        "Enlem", "Boylam" sütunları bulunmalıdır.</small>
                </div>
                <div class="form-actions">
                    <button id="uploadStoresBtn">Yükle</button>
                    <button id="cancelMultipleStoreBtn" style="background-color: #6c757d; color: white;">İptal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="autoRouteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Otomatik Rotalama</h3>
                <button class="close-modal"
                    onclick="document.getElementById('autoRouteModal').style.display='none'">&times;</button>
            </div>
            <div class="form-group">
                <label>Başlangıç Günü:</label>
                <input type="number" id="optimizeStartDay" class="form-control" min="1" max="28" value="1"
                    style="width: 100%; padding: 8px;">
            </div>
            <div class="form-group"
                style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; color: #555;">
                <p style="margin: 0;"><strong>Nasıl Çalışır?</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>Mevcut mağazaları birbirine en yakın olacak şekilde sıralar.</li>
                    <li>Günlük 8 saat mesaiye göre mağazaları günlere böler.</li>
                    <li>Seçim yaptıysanız sadece seçili mağazaları, yapmadıysanız hepsini planlar.</li>
                    <li><b>Pazar günleri</b> (7, 14, 21, 28) otomatik olarak atlanır.</li>
                </ul>
            </div>
            <div class="form-actions">
                <button id="startAutoOptimizeBtn" style="background-color: #6f42c1; color: white;">Planlamayı
                    Başlat</button>
            </div>
        </div>
    </div>

    <!-- YENİ: Template verilerini JS'den ayır (linter ve bakım için) -->
    <script type="application/json" id="stores-data">{{ store_data | safe }}</script>
    <script type="application/json" id="schedule-data">{{ initial_schedule | safe }}</script>
    <script type="application/json" id="all-merch-data">{{ all_merch | tojson | safe }}</script>
    <script type="application/json" id="is-frozen-data">{{ is_frozen | tojson | safe }}</script>

    <!-- YENİ: PROJE KAYDETME MODAL'I -->
    <div id="saveProjectModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3><i class="fas fa-save"></i> Proje Kaydet</h3>
                <button class="close-modal"
                    onclick="document.getElementById('saveProjectModal').style.display='none'">&times;</button>
            </div>

            <div class="form-group">
                <label>Proje Adı:</label>
                <input type="text" id="projectNameInput" placeholder="Örn: İstanbul Bölgesi Ocak 2026"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Bu proje adıyla tüm planlama verileriniz kaydedilecek
                </small>
            </div>

            <div id="projectSaveInfo"
                style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin: 10px 0; font-size: 12px; color: #0c5460;">
                <strong>Kaydedilecek veriler:</strong>
                <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li>Yüklenen Excel verileri</li>
                    <li>Tüm planlama ve atamalar</li>
                    <li>Mağaza notları</li>
                    <li>Düzenlemeler</li>
                </ul>
            </div>

            <div class="form-actions">
                <button id="confirmSaveProjectBtn" style="background-color: #28a745; color: white; flex: 2;">
                    <i class="fas fa-check"></i> Kaydet
                </button>
                <button onclick="document.getElementById('saveProjectModal').style.display='none'"
                    style="background-color: #6c757d; color: white; flex: 1;">
                    İptal
                </button>
            </div>
        </div>
    </div>

    <div id="serverModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-network-wired"></i> Docker Server Bağlantısı</h3>
                <button class="close-modal"
                    onclick="document.getElementById('serverModal').style.display='none'">&times;</button>
            </div>

            <div class="server-status-wrapper">
                <span style="font-weight: bold;">Durum:</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="connectionStatusText" style="font-size: 12px; color: #dc3545;">Bağlı Değil</span>
                    <div id="modalStatusLight" class="status-indicator"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Port veya URL Giriniz:</label>
                <input type="text" id="serverPortInput" placeholder="Örn: 5000 (Boş bırakılırsa otomatik denenir)"
                    style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    * Boş bırakıp 'Bağlan' derseniz varsayılan (localhost:5000) denenir.
                </small>
            </div>

            <div class="form-actions">
                <button id="connectServerBtn"
                    style="background-color: #007bff; color: white; width: 100%; padding: 12px; font-weight: bold;">
                    <i class="fas fa-plug"></i> Bağlan ve Test Et
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // ÖNCE TÜM DOM ELEMENTLERİNİ TANIMLA
        let bulkAssignControls, selectedCountDisplay;

        // YENİ: Ctrl ile serbest rota seçimi
        let ctrlKeyDown = false;
        let ctrlRoutePopup = null;

        // Sayfa yüklendikten sonra DOM elementlerini al
        document.addEventListener('DOMContentLoaded', function () {
            bulkAssignControls = document.getElementById("bulkAssignControls");
            selectedCountDisplay = document.getElementById("selectedCount");

            // YENİ: Ana excel dosya ismi gösterimi
            const mainExcelInput = document.getElementById('mainExcelFileInput');
            const mainExcelName = document.getElementById('mainExcelFileName');
            if (mainExcelInput && mainExcelName) {
                mainExcelInput.addEventListener('change', () => {
                    const f = mainExcelInput.files?.[0];
                    mainExcelName.textContent = f ? f.name : 'Dosya seçilmedi';
                });
            }

            // YENİ: Ekle butonu ve modal event listener'ları
            setupAddStoreModal();

            // YENİ: Arama filtreleri için event listener'lar
            setupSearchFilters();

            // Event listener'ları burada ekle
            setupEventListeners();

            // YENİ: Proje yönetimi event listener'ları
            setupProjectManagement();

            // --- SERVER BAĞLANTI AYARLARI ---
            const serverModal = document.getElementById('serverModal');
            const serverBtn = document.getElementById('serverSettingsBtn');
            const connectBtn = document.getElementById('connectServerBtn');
            const sidebarLight = document.getElementById('sidebarStatusLight');
            const modalLight = document.getElementById('modalStatusLight');
            const statusText = document.getElementById('connectionStatusText');

            if (serverBtn) {
                serverBtn.addEventListener('click', () => {
                    serverModal.style.display = 'block';
                });
            }

            // YENİ: Bağlantı durumu takibi (localStorage ile)
            let lastConnectionStatus = localStorage.getItem('dockerConnectionStatus') || 'unknown';

            if (connectBtn) {
                connectBtn.addEventListener('click', async () => {
                    const port = document.getElementById('serverPortInput').value.trim();

                    // UI Güncelleme (Test ediliyor...)
                    connectBtn.disabled = true;
                    connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test Ediliyor...';
                    statusText.textContent = "Bağlanıyor...";
                    statusText.style.color = "#ffc107"; // Sarı

                    try {
                        const response = await fetch('/api/check_connection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ port: port })
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            // Başarılı Bağlantı (Yeşil)
                            const wasConnected = sidebarLight.classList.contains('connected');
                            sidebarLight.classList.add('connected');
                            modalLight.classList.add('connected');
                            statusText.textContent = "Bağlandı: " + data.url;
                            statusText.style.color = "#28a745";

                            // GÜNCELLEME: Sadece durum değiştiğinde alert göster
                            if (lastConnectionStatus !== 'connected') {
                                alert("✅ Docker Server bağlantısı başarılı!");
                            }
                            lastConnectionStatus = 'connected';
                            localStorage.setItem('dockerConnectionStatus', 'connected');

                            // Modalı kapat
                            setTimeout(() => { serverModal.style.display = 'none'; }, 1000);
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (error) {
                        // Hata Durumu (Kırmızı)
                        const wasConnected = sidebarLight.classList.contains('connected');
                        sidebarLight.classList.remove('connected');
                        modalLight.classList.remove('connected');
                        statusText.textContent = "Hata: " + error.message;
                        statusText.style.color = "#dc3545";

                        // GÜNCELLEME: Sadece durum değiştiğinde alert göster
                        if (lastConnectionStatus === 'connected') {
                            alert("❌ Bağlantı başarısız: " + error.message);
                        }
                        lastConnectionStatus = 'disconnected';
                        localStorage.setItem('dockerConnectionStatus', 'disconnected');
                    } finally {
                        connectBtn.disabled = false;
                        connectBtn.innerHTML = '<i class="fas fa-plug"></i> Bağlan ve Test Et';
                    }
                });
            }

            // GÜNCELLEME: Sayfa açıldığında otomatik test yap ama alert gösterme
            if (connectBtn) {
                setTimeout(async () => {
                    try {
                        const response = await fetch('/api/check_connection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ port: '' })
                        });
                        const data = await response.json();

                        if (data.status === 'success') {
                            sidebarLight.classList.add('connected');
                            modalLight.classList.add('connected');
                            statusText.textContent = "Bağlandı: " + data.url;
                            statusText.style.color = "#28a745";
                            lastConnectionStatus = 'connected';
                            localStorage.setItem('dockerConnectionStatus', 'connected');
                        } else {
                            sidebarLight.classList.remove('connected');
                            modalLight.classList.remove('connected');
                            statusText.textContent = "Bağlı Değil";
                            statusText.style.color = "#dc3545";
                            lastConnectionStatus = 'disconnected';
                            localStorage.setItem('dockerConnectionStatus', 'disconnected');
                        }
                    } catch (error) {
                        sidebarLight.classList.remove('connected');
                        modalLight.classList.remove('connected');
                        statusText.textContent = "Bağlı Değil";
                        statusText.style.color = "#dc3545";
                        lastConnectionStatus = 'disconnected';
                        localStorage.setItem('dockerConnectionStatus', 'disconnected');
                    }
                }, 500);
            }

            // --- YENİ: OTOMATİK ROTALAMA İŞLEMLERİ ---

            // 1. Modalı Açma Butonu
            const openAutoRouteBtn = document.getElementById('openAutoRouteModalBtn');
            if (openAutoRouteBtn) {
                openAutoRouteBtn.addEventListener('click', function () {
                    // Varsayılan başlangıç: 1. gün
                    const dayInput = document.getElementById('optimizeStartDay');
                    if (dayInput) dayInput.value = 1;
                    document.getElementById('autoRouteModal').style.display = 'block';
                });
            }

            // 2. Başlatma Butonu
            const startAutoOptimizeBtn = document.getElementById('startAutoOptimizeBtn');
            if (startAutoOptimizeBtn) {
                startAutoOptimizeBtn.addEventListener('click', async function () {
                    const startDayRaw = document.getElementById('optimizeStartDay')?.value;
                    const startDay = parseInt(String(startDayRaw || '').trim(), 10);
                    if (!Number.isFinite(startDay) || startDay < 1 || startDay > 28) {
                        alert("Lütfen 1 ile 28 arasında geçerli bir başlangıç günü girin.");
                        return;
                    }

                    // Hangi mağazalar? (Seçili varsa onlar, yoksa hepsi)
                    let storesToOptimize = [];
                    if (selectedStores.size > 0) {
                        selectedStores.forEach(name => {
                            const s = stores.find(x => x['Mağaza İsmi'] === name);
                            if (s) storesToOptimize.push(s);
                        });
                    } else {
                        storesToOptimize = stores; // Tüm mağazalar
                    }

                    if (storesToOptimize.length === 0) {
                        alert("İşlenecek mağaza bulunamadı.");
                        return;
                    }

                    // UI Güncelleme (Butonu kilitle)
                    startAutoOptimizeBtn.disabled = true;
                    startAutoOptimizeBtn.textContent = "Hesaplanıyor, lütfen bekleyin...";

                    try {
                        const response = await fetch('/api/auto_optimize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stores: storesToOptimize,
                                start_day: startDay,
                                cycle_days: 28
                            })
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            // Gelen veriyi işle
                            processOptimizedData(data.optimized_stores);

                            document.getElementById('autoRouteModal').style.display = 'none';
                            alert("✅ Optimizasyon tamamlandı! Harita güncellendi.");
                        } else {
                            alert("❌ Hata: " + data.message);
                        }

                    } catch (error) {
                        console.error("Optimizasyon hatası:", error);
                        alert("Bir bağlantı hatası oluştu.");
                    } finally {
                        startAutoOptimizeBtn.disabled = false;
                        startAutoOptimizeBtn.textContent = "Planlamayı Başlat";
                    }
                });
            }

            // YENİ: Minimum gün aralığı değerini localStorage'dan yükle
            const savedInterval = localStorage.getItem('minDayInterval');
            if (savedInterval) {
                document.getElementById('minDayInterval').value = savedInterval;
            }

            // YENİ: Mağaza isimlerini göster butonu event listener
            const toggleStoreNamesBtn = document.getElementById('toggleStoreNamesBtn');
            if (toggleStoreNamesBtn) {
                toggleStoreNamesBtn.addEventListener('click', toggleStoreNames);
            }

            // YENİ: Kare seçim modunu başlat
            initializeRectangleSelection();

            // YENİ: Otomatik sıralama butonu event listener
            const autoSortBtn = document.getElementById('autoSortAllDaysBtn');
            if (autoSortBtn) {
                autoSortBtn.addEventListener('click', autoSortAllDays);
            }
        });

        // 3. Gelen Veriyi Sisteme İşleme Fonksiyonu
        function processOptimizedData(optimizedStores) {
            // Gelen listedeki her mağaza için
            optimizedStores.forEach(optStore => {
                const name = optStore['Mağaza İsmi'];
                const date = optStore['Atanan Tarih'];
                const merch = optStore['Personel']; // Backend'den gelen personel (yoksa varsayılan)

                // 1. Ana mağaza listesindeki personel bilgisini güncelle
                const mainStore = stores.find(s => s['Mağaza İsmi'] === name);
                if (mainStore) {
                    // Eğer backend'de personel atanmışsa güncelle
                    if (merch && merch !== 'Atanmamış') {
                        mainStore.Personel = merch;
                    }
                    // isNew işaretini kaldır
                    mainStore.isNew = false;
                }

                // 2. Schedule (Plan) nesnesini güncelle
                if (!schedule[name]) schedule[name] = [];

                // Tarihi ekle (Eğer zaten yoksa)
                if (date && !schedule[name].includes(date)) {
                    schedule[name].push(date);
                }

                // 3. DailyOrder (Günlük Sıralama) nesnesini güncelle
                // Backend zaten sıralı gönderdiği için, gelen sırayla ekliyoruz
                if (date) {
                    if (!dailyOrder[date]) dailyOrder[date] = {};
                    // Personel bazlı grouping yoksa genel yapıyı koru veya backendden gelen personeli kullan
                    const targetMerch = merch || findMerchForStore(name) || 'Belirtilmemiş';

                    if (!dailyOrder[date][targetMerch]) dailyOrder[date][targetMerch] = [];

                    // Mağaza listede yoksa ekle
                    if (!dailyOrder[date][targetMerch].includes(name)) {
                        dailyOrder[date][targetMerch].push(name);
                    }
                }
            });

            // 4. Arayüzü Yenile
            populateFilters(); // Filtreleri (Tarih, Personel) güncelle
            applyAllFilters(); // Haritadaki markerları boya
            updateAllMarkersAppearance(); // Marker renklerini kesinleştir

            // Eğer seçim yapıldıysa seçimleri temizle
            clearAllSelections();
        }

        // YENİ: Mağaza isimlerini göster/gizle fonksiyonu
        let showStoreNames = false;
        function toggleStoreNames() {
            showStoreNames = !showStoreNames;
            const btn = document.getElementById('toggleStoreNamesBtn');
            btn.textContent = showStoreNames ? 'Mağaza İsimlerini Gizle' : 'Mağaza İsimlerini Göster';

            updateAllStoreNameLabels();
        }

        // YENİ: Frekansları göster/gizle fonksiyonu
        let showFrequencies = false;
        function toggleFrequencies() {
            showFrequencies = !showFrequencies;
            const btn = document.getElementById('toggleFrequencyBtn');
            btn.textContent = showFrequencies ? 'Frekansları Gizle' : 'Frekansları Göster';

            updateAllMarkersAppearance();
        }

        // YENİ: Bir mağazanın frekans sayısını hesapla (sağ listede kaç tane varsa)
        function getStoreFrequencyCount(storeName) {
            if (!schedule[storeName] || schedule[storeName].length === 0) {
                return 0;
            }
            return schedule[storeName].length;
        }

        // YENİ: Talep Frekansı ile gerçek frekansı karşılaştır (eksik frekans kontrolü)
        function hasLowFrequency(storeName) {
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            if (!store) return false;

            const talepFrekansStr = store['Talep Frekansı'] || store['Talep Frekans'] || '';
            if (!talepFrekansStr || talepFrekansStr.trim() === '' || talepFrekansStr.toLowerCase() === 'nan') {
                return false;
            }

            const talepFrekans = parseInt(talepFrekansStr, 10);
            if (isNaN(talepFrekans) || talepFrekans <= 0) {
                return false;
            }

            const gercekFrekans = getStoreFrequencyCount(storeName);
            return gercekFrekans < talepFrekans;
        }

        // YENİ: Talep Frekansına göre renk belirleme fonksiyonu
        function getColorByTalepFrekans(storeName) {
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            if (!store) return null;

            const talepFrekansStr = store['Talep Frekansı'] || store['Talep Frekans'] || '';
            if (!talepFrekansStr || talepFrekansStr.trim() === '' || talepFrekansStr.toLowerCase() === 'nan') {
                return null;
            }

            const talepFrekans = parseInt(talepFrekansStr, 10);
            if (isNaN(talepFrekans) || talepFrekans <= 0) {
                return null;
            }

            // YENİ: Gerçek frekansı kontrol et - eğer talep frekansına ulaşmışsa veya geçmişse renk verme (beyaz)
            const gercekFrekans = getStoreFrequencyCount(storeName);
            if (gercekFrekans >= talepFrekans) {
                return null; // Talep frekansına ulaşıldı, beyaz (normal renk)
            }

            // Frekansa göre renk döndür (sadece talep frekansına ulaşmamışsa)
            switch (talepFrekans) {
                case 1:
                    return null; // Beyaz (varsayılan, değişiklik yok)
                case 2:
                    return '#FFF9C4'; // Açık sarı
                case 3:
                    return '#B3E5FC'; // Açık mavi
                case 4:
                    return '#E0E0E0'; // Açık gri
                case 5:
                    return '#FFE0B2'; // Açık turuncu
                case 6:
                    return '#FFCDD2'; // Açık kırmızı
                default:
                    // 6'dan büyükse açık kırmızı
                    return '#FFCDD2';
            }
        }

        // YENİ: Tüm mağaza ismi etiketlerini güncelle
        function updateAllStoreNameLabels() {
            for (const storeName in markers) {
                updateStoreNameLabel(storeName);
            }
        }

        // YENİ: Tekil mağaza ismi etiketini güncelle
        function updateStoreNameLabel(storeName) {
            const marker = markers[storeName];
            if (!marker) return;

            // Mevcut etiketleri temizle
            const existingTooltip = marker.getTooltip();
            if (existingTooltip) {
                marker.unbindTooltip();
            }

            // Eğer mağaza isimleri gösteriliyorsa yeni etiket ekle
            if (showStoreNames) {
                marker.bindTooltip(storeName, {
                    permanent: true,
                    direction: 'top',
                    className: 'store-name-tooltip'
                }).openTooltip();
            }
        }


        // YENİ: GENİŞLETİLMİŞ RENK PALETİ - 28 FARKLI RENK
        const colorPalette28 = [
            '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', '#E6B333', '#3366E6',
            '#999966', '#99FF99', '#B34D4D', '#80B300', '#809900', '#E6B3B3', '#6680B3',
            '#66991A', '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
            '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC', '#66664D', '#991AFF',
            '#E666FF'
        ];

        // YENİ: ÖZEL SVG MARKER RENKLERİ - colorPalette28 ile aynı sırada
        const markerColors28 = [
            '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', '#E6B333', '#3366E6',
            '#999966', '#99FF99', '#B34D4D', '#80B300', '#809900', '#E6B3B3', '#6680B3',
            '#66991A', '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
            '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC', '#66664D', '#991AFF',
            '#E666FF'
        ];

        // YENİ: Güncellenmiş renk eşleme fonksiyonu
        function getAppearanceForDate(date) {
            // Tarihe göre sabit bir indeks oluştur
            let hash = 0;
            for (let i = 0; i < date.length; i++) {
                hash = date.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colorIndex = Math.abs(hash) % colorPalette28.length;

            if (!dateColorMap[date]) {
                dateColorMap[date] = {
                    bg: colorPalette28[colorIndex],
                    markerColor: markerColors28[colorIndex]
                };
            }
            return dateColorMap[date];
        }

        // YENİ: Minimum gün aralığı kontrolü uygula
        function applyFrequencyCheck() {
            const minInterval = parseInt(document.getElementById('minDayInterval').value);
            localStorage.setItem('minDayInterval', minInterval);
            updateScheduleList();
            alert(`Minimum gün aralığı ${minInterval} gün olarak ayarlandı. Frekans ihlalleri kontrol ediliyor.`);
        }

        // YENİ: Güncellenmiş frekans kontrol fonksiyonu
        function hasFrequencyViolation(storeName) {
            const dates = schedule[storeName];
            if (!dates || dates.length < 2) {
                return false;
            }

            const minInterval = parseInt(document.getElementById('minDayInterval').value) || 13;

            const parseDateOrDay = (val) => {
                const s = String(val || '').trim();
                // Tarih (GG.AA.YYYY)
                const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
                if (m) {
                    const d = parseInt(m[1], 10), mo = parseInt(m[2], 10), y = parseInt(m[3], 10);
                    const dt = new Date(y, mo - 1, d);
                    if (!isNaN(dt.getTime())) return { type: 'date', value: dt };
                }
                // Gün (1, 1. Gün, 5.Gün)
                const g = s.match(/^(\d+)(\.\s*(Gün|Gun|G|gün|gun))?$/i);
                if (g) {
                    return { type: 'day', value: parseInt(g[1], 10) };
                }
                return null;
            };

            const parsed = dates.map(convertDateFormat).map(parseDateOrDay).filter(Boolean);
            if (parsed.length < 2) return false;

            const anyDate = parsed.some(p => p.type === 'date');
            if (anyDate) {
                const dateVals = parsed.filter(p => p.type === 'date').map(p => p.value.getTime()).sort((a, b) => a - b);
                for (let i = 0; i < dateVals.length - 1; i++) {
                    const diffTime = Math.abs(dateVals[i + 1] - dateVals[i]);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < minInterval) return true;
                }
                return false;
            }

            const dayVals = parsed.map(p => p.value).sort((a, b) => a - b);
            for (let i = 0; i < dayVals.length - 1; i++) {
                const diffDays = dayVals[i + 1] - dayVals[i];
                if (diffDays < minInterval) return true;
            }
            return false;
        }

        // YENİ: Ekle butonu ve modal kurulumu
        function setupAddStoreModal() {
            const addStoreBtn = document.getElementById('addStoreBtn');
            const modal = document.getElementById('addStoreModal');
            const closeModal = document.querySelector('.close-modal');
            const cancelSingleBtn = document.getElementById('cancelSingleStoreBtn');
            const cancelMultipleBtn = document.getElementById('cancelMultipleStoreBtn');
            const modalTabs = document.querySelectorAll('.modal-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const saveSingleStoreBtn = document.getElementById('saveSingleStoreBtn');
            const uploadStoresBtn = document.getElementById('uploadStoresBtn');

            // Modal açma
            if (addStoreBtn) {
                addStoreBtn.addEventListener('click', function () {
                    modal.style.display = 'block';
                });
            }

            // Modal kapama
            function closeModalFunc() {
                modal.style.display = 'none';
                // Formları temizle
                document.getElementById('storeName').value = '';
                document.getElementById('storeLat').value = '';
                document.getElementById('storeLng').value = '';
                document.getElementById('storeExcelFile').value = '';
            }

            if (closeModal) closeModal.addEventListener('click', closeModalFunc);
            if (cancelSingleBtn) cancelSingleBtn.addEventListener('click', closeModalFunc);
            if (cancelMultipleBtn) cancelMultipleBtn.addEventListener('click', closeModalFunc);

            // Modal dışına tıklayınca kapat
            window.addEventListener('click', function (event) {
                if (event.target === modal) {
                    closeModalFunc();
                }
            });

            // Tab değiştirme
            modalTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Tüm tabları ve içerikleri deaktif et
                    modalTabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Seçili tabı ve içeriği aktif et
                    this.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });

            // Tekli mağaza kaydetme - DÜZELTME: Event listener düzgün çalışması için
            if (saveSingleStoreBtn) {
                // Önceki event listener'ları temizle
                saveSingleStoreBtn.replaceWith(saveSingleStoreBtn.cloneNode(true));
                // Yeni event listener ekle
                document.getElementById('saveSingleStoreBtn').addEventListener('click', function () {
                    const storeName = document.getElementById('storeName').value.trim();
                    const storeLat = document.getElementById('storeLat').value.trim();
                    const storeLng = document.getElementById('storeLng').value.trim();

                    if (!storeName || !storeLat || !storeLng) {
                        alert('Lütfen tüm alanları doldurun.');
                        return;
                    }

                    const latVal = parseCoordinate(storeLat);
                    const lngVal = parseCoordinate(storeLng);
                    if (latVal === null || lngVal === null) {
                        alert('Lütfen geçerli enlem ve boylam değerleri girin. (Virgül veya nokta kabul edilir)');
                        return;
                    }

                    addSingleStore(storeName, latVal, lngVal);
                    closeModalFunc();
                });
            }

            // Çoklu mağaza yükleme - DÜZELTME: Event listener düzgün çalışması için
            if (uploadStoresBtn) {
                // Önceki event listener'ları temizle
                uploadStoresBtn.replaceWith(uploadStoresBtn.cloneNode(true));
                // Yeni event listener ekle
                document.getElementById('uploadStoresBtn').addEventListener('click', function () {
                    const fileInput = document.getElementById('storeExcelFile');
                    if (!fileInput.files.length) {
                        alert('Lütfen bir Excel dosyası seçin.');
                        return;
                    }

                    uploadMultipleStores(fileInput.files[0]);
                });
            }
        }

        // YENİ: Tekli mağaza ekleme fonksiyonu - DÜZELTME: Bölge zorunluluğu kaldırıldı
        function addSingleStore(storeName, lat, lng) {
            try {
                console.log('Tekli mağaza ekleniyor:', storeName, lat, lng);

                // Mağaza zaten var mı kontrol et
                const existingStore = stores.find(s => normalizeStoreName(s?.['Mağaza İsmi']) === normalizeStoreName(storeName));
                if (existingStore) {
                    alert('Bu isimde bir mağaza zaten mevcut!');
                    return;
                }

                // Yeni mağaza objesi oluştur - DÜZELTME: Bölge alanı kaldırıldı
                const newStore = {
                    'Mağaza İsmi': storeName,
                    'Enlem': lat,
                    'Boylam': lng,
                    'Personel': '',
                    'Mağaza İçin Süre': '0',
                    'Plan Tarihi': '',
                    'İl': '',
                    'Bölge': '',  // Boş bırakılabilir
                    'Frekans': '',
                    'İlçe': '',
                    'isNew': true // Yeni eklenen mağaza işareti
                };

                // Stores dizisine ekle
                stores.push(newStore);

                // YENİ: Yeni mağaza için özel ikon oluştur
                const newStoreIcon = L.divIcon({
                    className: 'question-mark-icon new-store-marker',
                    html: '?',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });

                const marker = L.marker([lat, lng], { icon: newStoreIcon });
                marker.bindPopup(createPopupContent(storeName));
                enablePopupOnDoubleClick(marker);
                marker.on("popupopen", e => fetchAddress(lat, lng, e.popup));
                marker.on("click", (e) => {
                    if (isCtrlSelectionActive(e)) {
                        try {
                            if (e?.originalEvent) {
                                e.originalEvent.preventDefault();
                                e.originalEvent.stopPropagation();
                            }
                        } catch (err) { }
                        handleFreeRouteSelection(storeName, marker);
                        return;
                    }
                    if (multiSelectMode) {
                        handleMultiSelect(storeName);
                    }
                });

                markers[storeName] = marker;

                // YENİ: Mağaza ismi etiketini ekle
                updateStoreNameLabel(storeName);

                // Marker'ı haritaya ekle
                if (selectedRegion !== 'all') {
                    nonClusteredGroup.addLayer(marker);
                } else {
                    markerClusterGroup.addLayer(marker);
                }

                // Filtreleri güncelle
                populateFilters();
                applyAllFilters();

                alert(`"${storeName}" mağazası başarıyla eklendi.`);
            } catch (error) {
                console.error('Mağaza ekleme hatası:', error);
                alert('Mağaza eklenirken bir hata oluştu: ' + error.message);
            }
        }

        // YENİ: Çoklu mağaza yükleme fonksiyonu - DÜZELTME: İkon boyutu büyütüldü
        function uploadMultipleStores(file) {
            console.log('Dosya yükleniyor:', file.name);

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_stores', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hatası! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Backend yanıtı:', data);
                    if (data.status === 'success') {
                        // Yeni mağazaları mevcut stores dizisine ekle
                        let addedCount = 0;
                        data.stores.forEach(newStore => {
                            // Aynı isimde mağaza var mı kontrol et
                            const existingStore = stores.find(s => normalizeStoreName(s?.['Mağaza İsmi']) === normalizeStoreName(newStore?.['Mağaza İsmi']));
                            if (!existingStore) {
                                newStore.isNew = true; // Yeni eklenen mağaza işareti
                                stores.push(newStore);

                                // YENİ: Yeni mağaza için özel ikon oluştur
                                const newStoreIcon = L.divIcon({
                                    className: 'question-mark-icon new-store-marker',
                                    html: '?',
                                    iconSize: [35, 35],
                                    iconAnchor: [17, 17]
                                });

                                const latVal = parseCoordinate(newStore.Enlem);
                                const lngVal = parseCoordinate(newStore.Boylam);
                                if (latVal === null || lngVal === null) {
                                    return;
                                }
                                const marker = L.marker([latVal, lngVal], { icon: newStoreIcon });
                                marker.bindPopup(createPopupContent(newStore['Mağaza İsmi']));
                                enablePopupOnDoubleClick(marker);
                                marker.on("popupopen", e => fetchAddress(latVal, lngVal, e.popup));
                                marker.on("click", (e) => {
                                    if (isCtrlSelectionActive(e)) {
                                        try {
                                            if (e?.originalEvent) {
                                                e.originalEvent.preventDefault();
                                                e.originalEvent.stopPropagation();
                                            }
                                        } catch (err) { }
                                        handleFreeRouteSelection(newStore['Mağaza İsmi'], marker);
                                        return;
                                    }
                                    if (multiSelectMode) {
                                        handleMultiSelect(newStore['Mağaza İsmi']);
                                    }
                                });

                                markers[newStore['Mağaza İsmi']] = marker;

                                // YENİ: Mağaza ismi etiketini ekle
                                updateStoreNameLabel(newStore['Mağaza İsmi']);

                                // Marker'ı haritaya ekle
                                if (selectedRegion !== 'all') {
                                    nonClusteredGroup.addLayer(marker);
                                } else {
                                    markerClusterGroup.addLayer(marker);
                                }
                                addedCount++;
                            }
                        });

                        // Filtreleri güncelle
                        populateFilters();
                        applyAllFilters();

                        if (addedCount > 0) {
                            alert(`${addedCount} mağaza başarıyla eklendi.`);
                        } else {
                            alert('Tüm mağazalar zaten mevcut veya hiç mağaza eklenedi.');
                        }
                        document.getElementById('addStoreModal').style.display = 'none';
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Mağaza yükleme hatası:', error);
                    alert('Mağaza yüklenirken hata oluştu: ' + error.message);
                });
        }

        // YENİ: Arama filtreleri için kurulum
        function setupSearchFilters() {
            const storeSearchFilter = document.getElementById('storeSearchFilter');
            const cityFilter = document.getElementById('cityFilter');
            const districtFilter = document.getElementById('districtFilter');

            if (storeSearchFilter) {
                storeSearchFilter.addEventListener('input', function () {
                    applyAllFilters();
                    if (this.value.trim() !== '') {
                        focusOnFilteredStores();
                    }
                });
            }

            if (cityFilter) {
                cityFilter.addEventListener('change', function () {
                    applyAllFilters();
                    if (this.value !== 'all') {
                        focusOnFilteredStores();
                    }
                    updateDistrictFilter();
                });
            }

            if (districtFilter) {
                districtFilter.addEventListener('change', function () {
                    applyAllFilters();
                    if (this.value !== 'all') {
                        focusOnFilteredStores();
                    }
                });
            }

            // YENİ: Frekans filtresi event listener
            const frequencyFilter = document.getElementById('frequencyFilter');
            if (frequencyFilter) {
                frequencyFilter.addEventListener('change', function () {
                    applyAllFilters();
                    if (this.value !== 'all') {
                        focusOnFilteredStores();
                    }
                });
            }
        }

        // YENİ: Mağaza arama filtresini temizle
        function clearStoreFilter() {
            const storeSearchFilter = document.getElementById('storeSearchFilter');
            if (storeSearchFilter) {
                storeSearchFilter.value = '';
                applyAllFilters();
            }
        }

        // YENİ: İl filtresini temizle
        function clearCityFilter() {
            const cityFilter = document.getElementById('cityFilter');
            if (cityFilter) {
                cityFilter.value = 'all';
                applyAllFilters();
                updateDistrictFilter();
            }
        }

        // YENİ: İlçe filtresini temizle
        function clearDistrictFilter() {
            const districtFilter = document.getElementById('districtFilter');
            if (districtFilter) {
                districtFilter.value = 'all';
                applyAllFilters();
            }
        }

        // ============================================
        // YENİ: PROJE YÖNETİMİ FONKSİYONLARI
        // ============================================

        let currentProjectName = null; // Şu anda açık olan proje adı
        let currentProjectCreatedAt = null; // Proje oluşturulma zamanı

        // Proje yönetimi event listener'larını kur
        function setupProjectManagement() {
            const saveProjectBtn = document.getElementById('saveProjectBtn');
            const projectsMenuBtn = document.getElementById('projectsMenuBtn');
            const projectsDropdown = document.getElementById('projectsDropdown');
            const confirmSaveBtn = document.getElementById('confirmSaveProjectBtn');
            const projectNameInput = document.getElementById('projectNameInput');

            // Proje kaydet butonuna tıklandığında
            if (saveProjectBtn) {
                saveProjectBtn.addEventListener('click', function () {
                    // Eğer Excel yüklenmemişse uyar
                    if (!stores || stores.length === 0) {
                        alert('Önce bir Excel dosyası yüklemelisiniz!');
                        return;
                    }

                    // Modal'ı aç
                    document.getElementById('saveProjectModal').style.display = 'block';

                    // Eğer mevcut bir proje varsa, adını input'a yaz
                    if (currentProjectName) {
                        projectNameInput.value = currentProjectName;
                    } else {
                        projectNameInput.value = '';
                    }

                    projectNameInput.focus();
                });
            }

            // Projeler menüsüne tıklandığında
            if (projectsMenuBtn) {
                projectsMenuBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isVisible = projectsDropdown.style.display === 'block';
                    if (isVisible) {
                        projectsDropdown.style.display = 'none';
                    } else {
                        projectsDropdown.style.display = 'block';
                        loadProjectsList();
                    }
                });
            }

            // Dropdown dışına tıklandığında kapat
            document.addEventListener('click', function (e) {
                if (projectsDropdown && !projectsDropdown.contains(e.target) && e.target !== projectsMenuBtn) {
                    projectsDropdown.style.display = 'none';
                }
            });

            // Proje kaydet onayı
            if (confirmSaveBtn) {
                confirmSaveBtn.addEventListener('click', function () {
                    const projectName = projectNameInput.value.trim();
                    if (!projectName) {
                        alert('Lütfen bir proje adı girin!');
                        return;
                    }

                    saveCurrentProject(projectName);
                });
            }

            // Enter tuşuyla kaydet
            if (projectNameInput) {
                projectNameInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        confirmSaveBtn.click();
                    }
                });
            }
        }

        // Mevcut projeyi kaydet
        async function saveCurrentProject(projectName) {
            try {
                // CSV verisini al (LAST_UPLOADED_FILE_PATH'den)
                let csvData = '';
                // Not: CSV verisi backend'de zaten saklanıyor, burada sadece referans tutuyoruz

                const projectData = {
                    project_name: projectName,
                    created_at: currentProjectCreatedAt || new Date().toISOString().slice(0, 19).replace('T', ' '),
                    csv_data: csvData,
                    schedule: schedule,
                    daily_order: dailyOrder,
                    store_notes: storeNotes,
                    edited_stores: editedStores,
                    empty_days: emptyDays,
                    stores: stores
                };

                const response = await fetch('/api/save_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentProjectName = projectName;
                    if (!currentProjectCreatedAt) {
                        currentProjectCreatedAt = new Date().toISOString().slice(0, 19).replace('T', ' ');
                    }

                    alert('✅ ' + data.message);
                    document.getElementById('saveProjectModal').style.display = 'none';

                    // Proje listesini yenile
                    loadProjectsList();
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (error) {
                console.error('Proje kaydetme hatası:', error);
                alert('Proje kaydedilirken bir hata oluştu: ' + error.message);
            }
        }

        // Projeleri listele
        async function loadProjectsList() {
            try {
                const response = await fetch('/api/list_projects');
                const data = await response.json();

                const projectsList = document.getElementById('projectsList');
                if (!projectsList) return;

                if (data.status === 'success' && data.projects.length > 0) {
                    let html = '';

                    data.projects.forEach(project => {
                        const isCurrentProject = project.name === currentProjectName;
                        const bgColor = isCurrentProject ? '#e7f3ff' : 'white';
                        const fontWeight = isCurrentProject ? 'bold' : 'normal';

                        html += `
                            <div style="padding: 8px; border-bottom: 1px solid #eee; background-color: ${bgColor}; cursor: pointer; transition: background-color 0.2s;"
                                 onmouseover="this.style.backgroundColor='#f0f0f0'"
                                 onmouseout="this.style.backgroundColor='${bgColor}'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div onclick="loadProject('${project.name}')" style="flex: 1; font-weight: ${fontWeight};">
                                        <i class="fas fa-folder" style="margin-right: 5px; color: #6c757d;"></i>
                                        ${project.name}
                                        ${isCurrentProject ? '<span style="color: #28a745; font-size: 11px;"> (Açık)</span>' : ''}
                                    </div>
                                    <button onclick="event.stopPropagation(); deleteProject('${project.name}')" 
                                            style="background-color: #dc3545; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; font-size: 11px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                    Son değişiklik: ${project.last_modified}
                                </div>
                            </div>
                        `;
                    });

                    projectsList.innerHTML = html;
                } else {
                    projectsList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">Henüz kaydedilmiş proje yok</div>';
                }
            } catch (error) {
                console.error('Proje listeleme hatası:', error);
                const projectsList = document.getElementById('projectsList');
                if (projectsList) {
                    projectsList.innerHTML = '<div style="padding: 10px; text-align: center; color: #dc3545; font-size: 12px;">Projeler yüklenemedi</div>';
                }
            }
        }

        // Projeyi yükle
        async function loadProject(projectName) {
            if (!confirm(`"${projectName}" projesini yüklemek istediğinizden emin misiniz?\n\nMevcut çalışmanız kaydedilmemişse kaybolacaktır!`)) {
                return;
            }

            try {
                const response = await fetch('/api/load_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: projectName })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const projectData = data.project_data;

                    // Global değişkenleri güncelle (const olabilirler, yeniden atama yapamayız)
                    // Schedule'ı temizle ve doldur
                    for (const key in schedule) delete schedule[key];
                    Object.assign(schedule, projectData.schedule || {});

                    // DailyOrder'ı temizle ve doldur
                    for (const key in dailyOrder) delete dailyOrder[key];
                    Object.assign(dailyOrder, projectData.daily_order || {});

                    // StoreNotes'u temizle ve doldur
                    for (const key in storeNotes) delete storeNotes[key];
                    Object.assign(storeNotes, projectData.store_notes || {});

                    // EditedStores'u temizle ve doldur
                    for (const key in editedStores) delete editedStores[key];
                    Object.assign(editedStores, projectData.edited_stores || {});

                    // EmptyDays'i temizle ve doldur
                    for (const key in emptyDays) delete emptyDays[key];
                    Object.assign(emptyDays, projectData.empty_days || {});

                    // Stores array'ini temizle ve doldur
                    stores.length = 0;
                    stores.push(...(projectData.stores || []));

                    currentProjectName = projectData.name;
                    currentProjectCreatedAt = projectData.created_at;

                    // YENİ: Önce gösterme bayraklarını kapat (clearMapAndRebuild bu değerlere göre ikon çizecek)
                    showStoreNames = false;
                    showMerchNames = false;
                    const toggleStoreNamesBtn = document.getElementById('toggleStoreNamesBtn');
                    if (toggleStoreNamesBtn) toggleStoreNamesBtn.textContent = 'Mağaza İsimlerini Göster';
                    const toggleNamesBtn = document.getElementById('toggleNamesBtn');
                    if (toggleNamesBtn) toggleNamesBtn.textContent = 'Personel İsimlerini Göster';

                    // Haritayı temizle ve yeniden oluştur (yukarıdaki false değerleriyle çizilecek)
                    clearMapAndRebuild();

                    // Dropdown'ı kapat
                    document.getElementById('projectsDropdown').style.display = 'none';

                    alert('✅ Proje başarıyla yüklendi: ' + projectName);
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (error) {
                console.error('Proje yükleme hatası:', error);
                alert('Proje yüklenirken bir hata oluştu: ' + error.message);
            }
        }

        // Projeyi sil
        async function deleteProject(projectName) {
            if (!confirm(`"${projectName}" projesini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete_project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: projectName })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('✅ ' + data.message);

                    // Eğer silinen proje şu anda açık olan projeyse, sıfırla
                    if (currentProjectName === projectName) {
                        currentProjectName = null;
                        currentProjectCreatedAt = null;
                    }

                    // Proje listesini yenile
                    loadProjectsList();
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (error) {
                console.error('Proje silme hatası:', error);
                alert('Proje silinirken bir hata oluştu: ' + error.message);
            }
        }

        // Haritayı temizle ve yeniden oluştur
        function clearMapAndRebuild() {
            // Tüm marker'ları temizle
            for (const storeName in markers) {
                const marker = markers[storeName];
                if (markerClusterGroup.hasLayer(marker)) {
                    markerClusterGroup.removeLayer(marker);
                }
                if (nonClusteredGroup.hasLayer(marker)) {
                    nonClusteredGroup.removeLayer(marker);
                }
            }
            // Marker objesini temizle (const olduğu için yeniden atama yapamayız)
            for (const key in markers) {
                delete markers[key];
            }

            // Rota katmanlarını temizle
            routeLayer.clearLayers();
            freeRouteSelectionLayer.clearLayers();
            ctrlRouteLayer.clearLayers();
            
            // Haritadaki TÜM katmanları temizle (mağaza isim etiketleri dahil)
            // Sadece tile layer'ı (harita tabanını) koru
            map.eachLayer(function(layer) {
                // Tile layer değilse kaldır
                if (!(layer instanceof L.TileLayer)) {
                    map.removeLayer(layer);
                }
            });
            
            // Marker cluster gruplarını yeniden ekle
            map.addLayer(markerClusterGroup);
            map.addLayer(nonClusteredGroup);
            map.addLayer(routeLayer);
            map.addLayer(freeRouteSelectionLayer);
            map.addLayer(ctrlRouteLayer);

            // Personel kısa numara eşlemesini marker oluşturmadan önce doldur (isimler kapalıyken 1,2,3 gösterilsin)
            updateMerchNumberMap();

            // Yeni marker'ları oluştur
            stores.forEach(store => {
                const storeName = store['Mağaza İsmi'];
                const latVal = parseCoordinate(store.Enlem);
                const lngVal = parseCoordinate(store.Boylam);

                if (latVal === null || lngVal === null) return;

                const merchNumber = findMerchForStore(storeName);
                const dates = schedule[storeName] || [];
                let color = '#808080';

                if (dates.length > 0) {
                    dates.sort(compareDates);
                    const appearance = getAppearanceForDate(dates[0]);
                    color = appearance.markerColor;
                }

                const icon = createMerchIcon(color, merchNumber, storeName);
                const marker = L.marker([latVal, lngVal], { icon: icon });
                marker.bindPopup(createPopupContent(storeName));
                enablePopupOnDoubleClick(marker);
                marker.on("popupopen", e => fetchAddress(latVal, lngVal, e.popup));
                marker.on("click", (e) => {
                    if (isCtrlSelectionActive(e)) {
                        try {
                            if (e?.originalEvent) {
                                e.originalEvent.preventDefault();
                                e.originalEvent.stopPropagation();
                            }
                        } catch (err) { }
                        handleFreeRouteSelection(storeName, marker);
                        return;
                    }
                    if (multiSelectMode) {
                        handleMultiSelect(storeName);
                    }
                });

                markers[storeName] = marker;
                markerClusterGroup.addLayer(marker);
            });

            // Filtreleri ve listeleri güncelle
            populateFilters();
            applyAllFilters();
            updateScheduleList();
            updateMerchNumberMap();
        }

        // ============================================
        // PROJE YÖNETİMİ FONKSİYONLARI SONU
        // ============================================

        // YENİ: Filtrelenmiş mağazalara odaklan
        function focusOnFilteredStores() {
            const visibleMarkers = [];

            for (const storeName in markers) {
                const marker = markers[storeName];
                if (map.hasLayer(marker)) {
                    visibleMarkers.push(marker);
                }
            }

            if (visibleMarkers.length > 0) {
                const group = new L.featureGroup(visibleMarkers);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        // YENİ: İlçe filtresini güncelle (seçili ile göre)
        function updateDistrictFilter() {
            const cityFilter = document.getElementById('cityFilter');
            const districtFilter = document.getElementById('districtFilter');

            if (!cityFilter || !districtFilter) return;

            const selectedCity = cityFilter.value;
            const currentDistrict = districtFilter.value;

            // Mevcut ilçe seçeneklerini temizle
            while (districtFilter.options.length > 1) {
                districtFilter.remove(1);
            }

            if (selectedCity === 'all') {
                // Tüm ilçeleri göster
                const allDistricts = new Set();
                stores.forEach(store => {
                    if (store.İlçe && store.İlçe.trim() !== '') {
                        allDistricts.add(store.İlçe);
                    }
                });

                Array.from(allDistricts).sort().forEach(district => {
                    const option = new Option(district, district);
                    districtFilter.add(option);
                });
            } else {
                // Sadece seçili ile ait ilçeleri göster
                const cityDistricts = new Set();
                stores.forEach(store => {
                    if (store.İl === selectedCity && store.İlçe && store.İlçe.trim() !== '') {
                        cityDistricts.add(store.İlçe);
                    }
                });

                Array.from(cityDistricts).sort().forEach(district => {
                    const option = new Option(district, district);
                    districtFilter.add(option);
                });
            }

            // Eğer önceki seçim hala geçerliyse onu koru, değilse "Tümü" yap
            if (Array.from(districtFilter.options).some(opt => opt.value === currentDistrict)) {
                districtFilter.value = currentDistrict;
            } else {
                districtFilter.value = 'all';
            }
        }

        // YENİ: Şehir filtresini doldur
        function populateCityFilter() {
            const cityFilter = document.getElementById('cityFilter');
            if (!cityFilter) return;

            const existingValue = cityFilter.value;
            while (cityFilter.options.length > 1) {
                cityFilter.remove(1);
            }

            const allCities = new Set();
            stores.forEach(store => {
                if (store.İl && store.İl.trim() !== '') {
                    allCities.add(store.İl);
                }
            });

            Array.from(allCities).sort().forEach(city => {
                const option = new Option(city, city);
                cityFilter.add(option);
            });

            if (Array.from(cityFilter.options).some(opt => opt.value === existingValue)) {
                cityFilter.value = existingValue;
            }

            // İlçe filtresini güncelle
            updateDistrictFilter();
        }

        function setupEventListeners() {
            // Not: "Toplu Seçim Modu" checkbox kaldırıldı.
            // Seçimler Shift ile kare seçim / gün "Noktaları Seç" butonu ile yapılır.

            // YENİ: Ctrl tuşu ile serbest rota seçimi (checkbox yok)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Control') {
                    ctrlKeyDown = true;
                }
                // YENİ: Ctrl seçim temizleme - tekli seçimde de çalışsın
                if (e.key === 'Escape') {
                    try { clearCtrlRouteSession(); } catch (err) { }
                }
            }, true);
            document.addEventListener('keyup', (e) => {
                if (e.key === 'Control') {
                    ctrlKeyDown = false;
                }
            }, true);
            window.addEventListener('blur', () => {
                ctrlKeyDown = false;
                hideCtrlRoutePopup();
                try { stopRectangleDrawing(); } catch (e) { }
            });

            // Diğer event listener'lar...
            if (document.getElementById("dateFilter")) {
                document.getElementById("dateFilter").addEventListener("change", applyAllFilters);
            }
            if (document.getElementById("merchFilter")) {
                document.getElementById("merchFilter").addEventListener("change", applyAllFilters);
            }
            if (document.getElementById("regionFilter")) {
                document.getElementById("regionFilter").addEventListener("change", applyAllFilters);
            }
            if (document.getElementById("clearMapStateBtn")) {
                document.getElementById("clearMapStateBtn").addEventListener("click", () => {
                    try { routeLayer.clearLayers(); } catch (e) { }
                    try { clearFreeRouteSelection(); } catch (e) { }
                    try { clearAllSelections(); } catch (e) { }
                });
            }
            // Not: Serbest rota seçimi artık Ctrl ile yapıldığı için burada buton event'i yok.
            if (document.getElementById("bulkAssignBtn")) {
                document.getElementById("bulkAssignBtn").addEventListener("click", bulkAssignHandler);
            }
            if (document.getElementById("bulkClearDatesBtn")) {
                document.getElementById("bulkClearDatesBtn").addEventListener("click", bulkClearDatesHandler);
            }
            if (document.getElementById("bulkDeleteSpecificDateBtn")) {
                document.getElementById("bulkDeleteSpecificDateBtn").addEventListener("click", bulkDeleteSpecificDateHandler);
            }
            if (document.getElementById('savePlanBtn')) {
                document.getElementById('savePlanBtn').addEventListener('click', savePlanHandler);
            }
            if (document.getElementById('clearPlanBtn')) {
                document.getElementById('clearPlanBtn').addEventListener('click', clearPlanHandler);
            }
            if (document.getElementById("downloadFullPlanBtn")) {
                document.getElementById("downloadFullPlanBtn").addEventListener("click", () => { downloadPlan('full_plan'); });
            }
            if (document.getElementById("fixDayStoresBtn")) {
                document.getElementById("fixDayStoresBtn").addEventListener("click", fixDayStores);
            }
            if (document.getElementById('toggleNamesBtn')) {
                document.getElementById('toggleNamesBtn').addEventListener('click', function () {
                    showMerchNames = !showMerchNames;
                    this.textContent = showMerchNames ? 'Personel İsimlerini Gizle' : 'Personel İsimlerini Göster';
                    updateAllMarkersAppearance();
                });
            }
            if (document.getElementById('toggleFrequencyBtn')) {
                document.getElementById('toggleFrequencyBtn').addEventListener('click', toggleFrequencies);
            }
        }

        // HARİTA VE DİĞER KODLAR
        // GÜNCELLEME: boxZoom özelliği false yapılarak Shift tuşu ile yakınlaştırma devre dışı bırakıldı
        const map = L.map('map', { boxZoom: false }).setView([39, 35], 6);

        // GÜNCELLEME: Varsayılan harita görünümünü sokak haritası olarak değiştir
        const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });

        const classicMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '©OpenStreetMap, ©CartoDB',
            subdomains: 'abcd',
            maxZoom: 20
        });

        // GÜNCELLEME: Varsayılan olarak sokak haritasını ekle
        streetMap.addTo(map);

        // Katman kontrolünü doğru şekilde ekle
        const baseMaps = {
            "Sokak Haritası": streetMap,
            "Klasik Harita": classicMap
        };

        // Katman kontrolünü haritaya ekle
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // YENİ: ÖZEL SVG MARKER OLUŞTURMA FONKSİYONU
        // Not: Seçili görünüm artık setIcon ile değil DOM class ile yönetilir (performans için).
        function createCustomMarkerIcon(color, merchNumber = null, storeName = null) {
            // YENİ: Eğer mağaza yeni eklenmişse ve henüz atanmamışsa BÜYÜK soru işareti göster
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            if (store && store.isNew && (!schedule[storeName] || schedule[storeName].length === 0)) {
                const questionIcon = L.divIcon({
                    className: 'question-mark-icon new-store-marker',
                    html: '?',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });
                return questionIcon;
            }

            // SVG marker oluştur
            const svg = `
            <svg class="custom-marker-svg" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="1" dy="1" stdDeviation="2" flood-color="#000000" flood-opacity="0.6"/>
                    </filter>
                </defs>
                <path d="M12.5 0C5.6 0 0 5.6 0 12.5C0 21.5 12.5 41 12.5 41S25 21.5 25 12.5C25 5.6 19.4 0 12.5 0Z" 
                      fill="${color}" filter="url(#shadow)"/>
                <circle cx="12.5" cy="12.5" r="6" fill="white" opacity="0.8"/>
            </svg>
        `;

            let numberHtml = '';
            if (showFrequencies && storeName) {
                const frequencyCount = getStoreFrequencyCount(storeName);
                if (frequencyCount > 0) {
                    numberHtml = `<div class="merch-number">${frequencyCount}</div>`;
                }
            } else if (showMerchNames && merchNumber) {
                numberHtml = `<div class="merch-number">${merchNumber}</div>`;
            } else if (merchNumber) {
                const displayNumber = merchNumberMap[merchNumber] || merchNumber;
                numberHtml = `<div class="merch-number">${displayNumber}</div>`;
            }

            // Tarih çubuklarını oluştur
            let dateBarsHtml = '';
            let dateTooltipContent = '';
            if (storeName && schedule[storeName] && schedule[storeName].length > 0) {
                const dates = schedule[storeName];
                dateTooltipContent = dates.join(', ');

                dateBarsHtml = `
                <div class="date-bars-wrapper">
                    <div class="date-bars-container">
                        ${dates.map((date, index) => {
                    const appearance = getAppearanceForDate(date);
                    return `<div class="date-bar" style="background-color: ${appearance.bg}" title="${date}"></div>`;
                }).join('')}
                    </div>
                    <div class="date-tooltip">${dateTooltipContent}</div>
                </div>
            `;
            }

            const html = `
            <div class="merch-icon-container">
                ${svg}
                ${numberHtml}
                ${dateBarsHtml}
            </div>
        `;

            return L.divIcon({
                html: html,
                className: 'custom-marker-icon',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });
        }

        // YENİ: Template verilerini DOM'daki JSON script tag'lerinden oku
        let stores = JSON.parse(document.getElementById('stores-data')?.textContent || '[]');
        let schedule = JSON.parse(document.getElementById('schedule-data')?.textContent || '{}');
        // Backend'den gelen personel listesi
        const allMerch = JSON.parse(document.getElementById('all-merch-data')?.textContent || '[]');
        const IS_FROZEN_EXE = JSON.parse(document.getElementById('is-frozen-data')?.textContent || 'false');

        // GÜNCELLEME: Tarih formatı dönüşümü

        function convertDateFormat(dateStr) {
            if (!dateStr) return "";
            let str = String(dateStr).trim();

            // Excel'den gelen YYYY-AA-GG formatını GG.AA.YYYY'ye çevir (Sadece tarihse)
            const yyyyRegex = /^(\d{4})-(\d{2})-(\d{2})/;
            const match = str.match(yyyyRegex);
            if (match) {
                return `${match[3]}.${match[2]}.${match[1]}`;
            }

            // Eğer kullanıcı sadece sayı girdiyse (örn: "5"), ve sistem gün modundaysa bunu standartlaştırabiliriz
            // Ancak kullanıcının girdiği formatı korumak en güvenlisidir.
            // Sadece "X. Gün" formatını düzgün hale getirelim
            if (/^\d+$/.test(str)) {
                // Kullanıcı sadece sayı girdiyse (örn: 1), bunu "1. Gün" formatına çevirebiliriz
                // Veya sadece 1 olarak bırakabiliriz. Tutarlılık için "X. Gün" yapalım:
                return `${str}. Gün`;
            }

            return str;
        }

        // YENİ: Yardımcılar
        function normalizeStoreName(name) {
            return String(name || '')
                .trim()
                .replace(/\s+/g, ' ')
                .toLowerCase();
        }

        function parseCoordinate(val) {
            if (val === null || val === undefined) return null;
            const raw = String(val).trim();
            if (!raw) return null;
            const normalized = raw.replace(',', '.').replace(/\s+/g, '');
            // Basit sayı kontrolü (virgül/nokta sonrası ondalık destek)
            if (!/^[-+]?\d+(\.\d+)?$/.test(normalized)) return null;
            const num = parseFloat(normalized);
            return Number.isFinite(num) ? num : null;
        }

        // YENİ: Popup sadece çift tık ile açılsın
        function enablePopupOnDoubleClick(marker) {
            if (!marker) return;
            try {
                // Leaflet bindPopup default olarak click ile açmak için internal handler bağlar.
                // Bunu kaldırıp dblclick ile açıyoruz.
                if (marker._openPopup) {
                    marker.off('click', marker._openPopup);
                }
            } catch (e) { }

            marker.on('dblclick', (e) => {
                // Ctrl basılıyken seçim modu: popup açma
                if (isCtrlSelectionActive(e)) return;
                try {
                    if (e?.originalEvent) {
                        e.originalEvent.preventDefault();
                        e.originalEvent.stopPropagation();
                    }
                } catch (err) { }
                try { marker.openPopup(); } catch (err) { }
            });
        }

        // Schedule'daki tüm tarihleri dönüştür
        for (let storeName in schedule) {
            schedule[storeName] = schedule[storeName].map(convertDateFormat);
        }

        // EXE: UI açıkken heartbeat gönder (UI kapanınca ping durur -> server timeout ile kapanır)
        if (IS_FROZEN_EXE) {
            const sendPing = () => {
                try {
                    if (navigator.sendBeacon) {
                        navigator.sendBeacon('/ping');
                    } else {
                        fetch('/ping', { method: 'POST', keepalive: true });
                    }
                } catch (e) {
                    // sessiz geç
                }
            };
            sendPing();
            setInterval(sendPing, 3000);
        }

        const markers = {};
        let dailyOrder = {};
        let emptyDays = {};
        let storeNotes = {};
        let keepMarkerVisibleStoreName = null; // Not kaydedince simge kaybolmasın diye applyAllFilters'ta bu mağazayı her zaman göster
        let editedStores = {};
        const markerClusterGroup = L.markerClusterGroup();
        const nonClusteredGroup = L.featureGroup();
        let dateColorMap = {};
        let routeLayer = L.featureGroup().addTo(map);
        let freeRouteSelectionLayer = L.featureGroup().addTo(map);
        let ctrlRouteLayer = L.featureGroup().addTo(map);
        // Not: Serbest rota seçimi artık checkbox ile değil Ctrl tuşu ile aktif edilir.
        let selectedRoutePoints = [];
        let multiSelectMode = false;
        const selectedStores = new Set();
        let summaryCalculationId = 0;
        let showMerchNames = false;
        let merchNumberMap = {};

        // Kare seçim için değişkenler - SADECE SHIFT TUŞU İLE ÇALIŞACAK
        let rectangleDrawing = false;
        let rectangleStartPoint = null;
        let rectangleLayer = null;
        let rectangleListenersActive = false; // YENİ: Event listener durumunu takip etmek için

        // YENİ: Seçim ikonu
        const selectIcon = createCustomMarkerIcon('#ff0000', null, null);

        function loadPlanFromStorage() {
            const savedSchedule = localStorage.getItem('savedSchedule');
            const savedDailyOrder = localStorage.getItem('savedDailyOrder');
            const savedStoreNotes = localStorage.getItem('savedStoreNotes');
            const savedStores = localStorage.getItem('savedStores');
            const savedEmptyDays = localStorage.getItem('savedEmptyDays');
            if (savedSchedule && savedDailyOrder && savedStoreNotes && savedStores) {
                if (confirm('Daha önce kaydedilmiş bir çalışma bulundu. Yüklemek ister misiniz?')) {
                    schedule = JSON.parse(savedSchedule);
                    dailyOrder = JSON.parse(savedDailyOrder);
                    storeNotes = JSON.parse(savedStoreNotes);
                    stores = JSON.parse(savedStores);
                    emptyDays = savedEmptyDays ? JSON.parse(savedEmptyDays) : {};
                    editedStores = {};
                    return true;
                }
            }
            return false;
        }

        // Mağazalar yüklendiğinde veya kayıtlı veri varsa çalıştır
        if ((stores && stores.length > 0) || (localStorage.getItem('savedStores') && localStorage.getItem('savedStores') !== '[]')) {
            // Eğer stores boşsa ama kayıtlı veri varsa, yüklemeyi dene
            if ((!stores || stores.length === 0) && localStorage.getItem('savedStores')) {
                // loadPlanFromStorage false dönerse (kullanıcı hayır derse), stores boş kalır
                loadPlanFromStorage();
            } else {
                // Normal yükleme (stores doluysa)
                loadPlanFromStorage();
            }
            
            // Stores yüklendiyse filtreleri doldur
            if (stores && stores.length > 0) {
                populateCityFilter();
            }
        }

        // Personel numaralandırma fonksiyonu
        function updateMerchNumberMap() {
            merchNumberMap = {};
            const allMerchs = new Set();

            stores.forEach(store => {
                const merch = findMerchForStore(store['Mağaza İsmi']);
                if (merch) {
                    allMerchs.add(merch);
                }
            });

            let counter = 1;
            Array.from(allMerchs).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true })).forEach(merch => {
                merchNumberMap[merch] = counter++;
            });
        }

        // Personel seçim kutusunu doldur
        function populateBulkMerchSelect() {
            const bulkMerchSelect = document.getElementById('bulkMerchInput');
            if (!bulkMerchSelect) return;

            const allMerchs = new Set();

            stores.forEach(store => {
                const merch = findMerchForStore(store['Mağaza İsmi']);
                if (merch) {
                    allMerchs.add(merch);
                }
            });

            const sortedMerchs = Array.from(allMerchs).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));

            // Mevcut seçenekleri temizle (ilk seçenek hariç)
            while (bulkMerchSelect.options.length > 1) {
                bulkMerchSelect.remove(1);
            }

            sortedMerchs.forEach(merch => {
                const option = new Option(`Personel ${merch}`, merch);
                bulkMerchSelect.add(option);
            });
        }

        // YENİ: GÜNCELLENMİŞ MARKER İKON OLUŞTURMA - ÖZEL SVG KULLANIMI
        function createMerchIcon(color = '#808080', merchNumber = null, storeName = null) {
            return createCustomMarkerIcon(color, merchNumber, storeName);
        }

        // YENİ: Seçim görünümünü DOM class ile uygula (setIcon yapmadan)
        function applySelectionVisual(storeName) {
            const marker = markers[storeName];
            if (!marker) return;
            const el = marker.getElement?.();
            if (!el) return;
            const isSelected = selectedStores.has(storeName);
            if (isSelected) el.classList.add('selected-store');
            else el.classList.remove('selected-store');
        }

        function getAppearanceForDate(date) {
            // YENİ: 28 renk paleti kullanılıyor
            if (!dateColorMap[date]) {
                // Tarihe göre sabit bir indeks oluştur
                let hash = 0;
                for (let i = 0; i < date.length; i++) {
                    hash = date.charCodeAt(i) + ((hash << 5) - hash);
                }
                const colorIndex = Math.abs(hash) % colorPalette28.length;

                dateColorMap[date] = {
                    bg: colorPalette28[colorIndex],
                    markerColor: markerColors28[colorIndex]
                };
            }
            return dateColorMap[date];
        }

        function fetchAddress(lat, lon, popup) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
            fetch(url).then(res => res.json()).then(data => {
                const content = popup.getContent();
                const addressHtml = `<div class="address-info">${data?.display_name || "Adres bilgisi bulunamadı."}</div>`;
                popup.setContent(content.split('<div class="address-info">')[0] + addressHtml);
            }).catch(err => console.error("Adres getirme hatası:", err));
        }

        function findMerchForStore(storeName) {
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            return (store && store.Personel && String(store.Personel).trim() !== '' && String(store.Personel) !== 'nan') ? String(store.Personel).trim() : null;
        }

        // GÜNCELLEME: Hem Tarih hem de "X. Gün" formatı kontrolü

        function isValidDate(dateStr) {
            if (!dateStr) return false;
            const str = dateStr.trim();

            // 1. Klasik Tarih Kontrolü (GG.AA.YYYY)
            const dateRegex = /^\d{1,2}\.\d{1,2}\.\d{4}$/;
            if (dateRegex.test(str)) {
                const parts = str.split('.');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);

                if (year < 1000 || year > 3000 || month === 0 || month > 12) return false;
                const monthLength = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                if (year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0)) monthLength[1] = 29;
                return day > 0 && day <= monthLength[month - 1];
            }

            // 2. Gün Formatı Kontrolü (Örn: "1", "1. Gün", "5.Gün")
            // NOT: Günler 1..28 aralığında olmalı ve Pazar (7, 14, 21, 28) planlanmaz.
            const dayRegex = /^(\d+)(\.\s*(Gün|Gun|G|gün|gun))?$/;
            const m = str.match(dayRegex);
            if (m) {
                const n = parseInt(m[1], 10);
                if (!Number.isFinite(n)) return false;
                if (n < 1 || n > 28) return false;
                if (n % 7 === 0) return false; // Pazar
                return true;
            }

            return false;
        }

        // GÜNCELLEME: Akıllı Sıralama (Hem Tarih hem Gün Sayısı)

        function compareDates(a, b) {
            const strA = String(a).trim();
            const strB = String(b).trim();

            // 1. İkisi de Tarih mi? (GG.AA.YYYY)
            const dateRegex = /^\d{1,2}\.\d{1,2}\.\d{4}$/;
            if (dateRegex.test(strA) && dateRegex.test(strB)) {
                const partsA = strA.split('.');
                const dateA = new Date(parseInt(partsA[2]), parseInt(partsA[1]) - 1, parseInt(partsA[0]));

                const partsB = strB.split('.');
                const dateB = new Date(parseInt(partsB[2]), parseInt(partsB[1]) - 1, parseInt(partsB[0]));

                return dateA - dateB;
            }

            // 2. Gün formatı mı? (İçindeki sayıları çekip karşılaştır)
            const getNumber = (s) => {
                const match = s.match(/(\d+)/);
                return match ? parseInt(match[1], 10) : 0;
            };

            const numA = getNumber(strA);
            const numB = getNumber(strB);

            if (numA !== 0 && numB !== 0) {
                return numA - numB;
            }

            // 3. Hiçbiri değilse alfabetik sırala
            return strA.localeCompare(strB);
        }

        function createPopupContent(storeName) {
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            const duration = store?.['Mağaza İçin Süre'] || "0";
            const frekans = store?.Frekans || "N/A";
            const sehir = store?.İl || "N/A";
            const bolge = store?.Bölge || "";
            let dates = schedule[storeName] || [];

            dates.sort(compareDates);

            let dateListHtml = '<ul class="popup-date-list" id="popup-date-list-' + storeName.replace(/[^a-zA-Z0-9]/g, '') + '">';
            if (dates.length > 0) {
                dateListHtml += dates.map(date => {
                    const merch = findMerchForStore(storeName) || 'Belirtilmemiş';
                    const orderArray = (dailyOrder[date] && dailyOrder[date][merch]) ? dailyOrder[date][merch] : [];
                    const order = orderArray.indexOf(storeName) + 1;
                    return `<li data-date="${date}">
                        <span>${date}</span>
                        <div class="order-controls">
                            <span>Sıra:</span>
                            <input class="popup-order-input" type="number" min="1" value="${order}" data-date="${date}">
                            <button class="delete-date" onclick="deleteDate('${storeName}','${date}')">×</button>
                        </div>
                    </li>`;
                }).join('');
            } else {
                dateListHtml += "<li>Henüz gün atanmamış.</li>";
            }
            dateListHtml += "</ul>";

            const currentMerch = findMerchForStore(storeName) || '';
            const currentNote = storeNotes[storeName] || '';

            const allRegions = [...new Set(stores.map(s => s.Bölge).filter(b => b && b.trim() !== ''))].sort();
            let regionOptions = '<option value="">Bölge Seçiniz</option>';
            allRegions.forEach(region => {
                const selected = region === bolge ? 'selected' : '';
                regionOptions += `<option value="${region}" ${selected}>${region}</option>`;
            });

            // Personel seçim kutusu için options
            let merchOptions = '<option value="">Personel Seçiniz</option>';
            
            // YENİ: Eğer mevcut personel listede yoksa, geçici olarak ekle
            let effectiveAllMerch = [...allMerch];
            if (currentMerch && !effectiveAllMerch.includes(currentMerch)) {
                effectiveAllMerch.push(currentMerch);
                effectiveAllMerch.sort(); // Alfabetik sıra bozulmasın
            }

            effectiveAllMerch.forEach(merch => {
                const selected = merch === currentMerch ? 'selected' : '';
                merchOptions += `<option value="${merch}" ${selected}>${merch}</option>`;
            });

            const talepFrekans = store?.['Talep Frekansı'] || store?.['Talep Frekans'] || '';
            const talepFrekansDisplay = (talepFrekans && talepFrekans.trim() !== '' && talepFrekans.toLowerCase() !== 'nan') ? talepFrekans : 'N/A';

            const infoHtml = `<div class="popup-info-grid">
            <div>
                <label><b>Bölge</b></label>
                <select id="popup-region-select-${storeName}" style="padding: 2px; width: 100%;">${regionOptions}</select>
            </div>
            <div>
                <label><b>Personel</b></label>
                <select id="popup-merch-input-${storeName}" style="width: 100%;">${merchOptions}</select>
            </div>
            <span><b>İl:</b> ${sehir}</span>
            <span><b>Mağaza İçin Süre:</b> ${duration} dk</span>
            <span><b>Frekans:</b> ${frekans}</span>
            <span><b>T.Frekans:</b> ${talepFrekansDisplay}</span>
        </div>`;

            const sanitizedStoreName = storeName.replace(/[^a-zA-Z0-9]/g, '');
            const actionsHtml = `<div class="popup-actions">
            <div>
                <input type="text" id="popup-date-input-${storeName}" placeholder="Gün Ekle (1-28 / 1. Gün)" style="width: 100%;">
                <small style="color: #666;">Her gün için ayrı satır oluşturulacak (Pazar günleri planlanmaz)</small>
            </div>
            <div>
                ${currentNote ? `<div style="margin-bottom: 5px; background: #f9f9f9; padding: 5px; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: flex-start;">
                    <span style="font-size: 12px; white-space: pre-wrap; word-break: break-word; flex-grow: 1;"><b>Not:</b> ${currentNote}</span>
                    <button onclick="deleteStoreNote('${storeName}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 11px; flex-shrink: 0;" title="Notu Sil">X</button>
                </div>` : ''}
                <textarea id="popup-note-input-${sanitizedStoreName}" placeholder="Mağaza için not ekleyin..." style="min-height: 50px; width: 100%;">${currentNote}</textarea>
            </div>
            <button onclick="saveAllPopupChanges('${storeName}')" style="width:100%; padding: 8px;">Tüm Değişiklikleri Kaydet</button>
        </div>`;

            return `<b>${storeName}</b>${infoHtml}${dateListHtml}${actionsHtml}<div class="address-info">Adres yükleniyor...</div>`;
        }

        function updateSingleMarkerAppearance(storeName) {
            const marker = markers[storeName];
            if (!marker) return;
            const merchNumber = findMerchForStore(storeName);
            const dates = schedule[storeName] || [];
            let color = '#808080'; // Varsayılan gri renk
            if (dates.length > 0) {
                dates.sort(compareDates);
                const appearance = getAppearanceForDate(dates[0]);
                color = appearance.markerColor; // YENİ: markerColor kullanılıyor
            }
            const newIcon = createMerchIcon(color, merchNumber, storeName);
            marker.setIcon(newIcon);
            marker.getPopup().setContent(createPopupContent(storeName));

            // YENİ: Mağaza ismi etiketini güncelle
            updateStoreNameLabel(storeName);
            // Seçim sınıfını tekrar uygula (icon değişince DOM yeniden oluşur)
            setTimeout(() => applySelectionVisual(storeName), 0);
        }

        function updateStoreAppearanceAndLists(storeName) {
            updateSingleMarkerAppearance(storeName);
            applyAllFilters();
            updateScheduleList(); // YENİ: Liste güncellemesi (frekans gösterimi için)
        }

        function updateAllMarkersAppearance() {
            for (const storeName in markers) {
                updateSingleMarkerAppearance(storeName);
            }
        }

        window.saveAllPopupChanges = function (storeName) {
            let merchUpdated = false;
            let regionUpdated = false;
            let datesAdded = false;
            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
            if (!store) return;

            if (!editedStores[storeName]) {
                editedStores[storeName] = {};
            }

            const regionSelect = document.getElementById(`popup-region-select-${storeName}`);
            const newRegion = regionSelect ? regionSelect.value.trim() : '';
            const oldRegion = (store.Bölge != null && store.Bölge !== '') ? String(store.Bölge).trim() : '';
            if (regionSelect && oldRegion !== newRegion) {
                store.Bölge = newRegion;
                editedStores[storeName].Bölge = newRegion;
                regionUpdated = true;
            }

            const merchInput = document.getElementById(`popup-merch-input-${storeName}`);
            const newMerch = merchInput ? merchInput.value.trim() : '';
            const oldMerch = (store.Personel != null && store.Personel !== '') ? String(store.Personel).trim() : '';
            if (merchInput && oldMerch !== newMerch) {
                store.Personel = newMerch;
                editedStores[storeName].Personel = newMerch;
                merchUpdated = true;
            }

            const dateInput = document.getElementById(`popup-date-input-${storeName}`);
            const dateValue = dateInput ? dateInput.value.trim() : '';
            if (dateValue) {
                const dateEntries = dateValue.split(',').map(d => d.trim()).filter(d => d && isValidDate(d));

                if (dateEntries.length > 0) {
                    if (!schedule[storeName]) {
                        schedule[storeName] = [];
                    }

                    dateEntries.forEach(dateEntry => {
                        const convertedDate = convertDateFormat(dateEntry);
                        if (!schedule[storeName].includes(convertedDate)) {
                            schedule[storeName].push(convertedDate);
                            datesAdded = true;
                        }
                    });

                    dateInput.value = "";
                }
            }

            const sanitizedStoreName = storeName.replace(/[^a-zA-Z0-9]/g, '');
            const noteInput = document.getElementById(`popup-note-input-${sanitizedStoreName}`);
            if (noteInput) {
                storeNotes[storeName] = noteInput.value.trim();
            } else {
                const popup = document.querySelector('.leaflet-popup-content');
                if (popup) {
                    const textarea = popup.querySelector('textarea[placeholder*="not"]');
                    if (textarea) storeNotes[storeName] = textarea.value.trim();
                }
            }

            const dateListContainer = document.getElementById('popup-date-list-' + storeName.replace(/[^a-zA-Z0-9]/g, ''));
            const orderInputs = dateListContainer ? dateListContainer.querySelectorAll('.popup-order-input') : [];
            orderInputs.forEach(input => {
                const date = input.dataset.date;
                const newOrder = parseInt(input.value, 10);
                const merch = findMerchForStore(storeName) || 'Belirtilmemiş';
                if (dailyOrder[date] && dailyOrder[date][merch]) {
                    const orderArray = dailyOrder[date][merch];
                    const oldIndex = orderArray.indexOf(storeName);
                    const newIndex = newOrder - 1;
                    if (oldIndex !== -1 && newIndex >= 0 && newIndex < orderArray.length) {
                        orderArray.splice(oldIndex, 1);
                        orderArray.splice(newIndex, 0, storeName);
                    }
                }
            });

            if (merchUpdated) {
                populateMerchFilter();
                updateMerchNumberMap();
                populateBulkMerchSelect();
                updateAllMarkersAppearance();
            }
            if (regionUpdated) {
                populateRegionFilter();
            }

            // YENİ: Eğer mağaza yeni eklenmişse ve artık ataması varsa, isNew işaretini kaldır
            if (store.isNew && (schedule[storeName] && schedule[storeName].length > 0 || store.Personel)) {
                store.isNew = false;
            }

            // Sadece not (veya sıra) değiştiyse: applyAllFilters çağırma; sonra biri çağırsa bile bu simgeyi koru
            const onlyNoteOrOrderChanged = !merchUpdated && !regionUpdated && !datesAdded;
            if (!onlyNoteOrOrderChanged) {
                // Not değişmiş olabilir, popup içeriğini güncellemek gerekir (önizleme alanı için)
                // Ancak updateStoreAppearanceAndLists zaten updateSingleMarkerAppearance çağırır, o da popup içeriğini günceller.
                // updateStoreAppearanceAndLists(storeName) çağrıldığı için sorun olmaması lazım.
                // Belki de "else" bloğundaki durum için sorun vardır.
                // Aslında sadece not değiştiğinde de popup içeriğini güncellemeliyiz.
                
                // NOT: Eğer sadece not değiştiyse updateStoreAppearanceAndLists çağrılıyor.
                // Bu fonksiyon updateSingleMarkerAppearance -> marker.getPopup().setContent(...) yapar.
                // Dolayısıyla popup içeriği yenilenir.
                // Ancak kullanıcı "tekrardan tıkladığım zaman" diyor.
                // Belki de storeNotes güncellenirken bir sorun oluyor.
                
                // KOD İNCELEMESİ SONUCU: 
                // Yukarıda 'storeNotes[storeName] = noteInput.value.trim();' yapılıyor.
                // Sonra updateStoreAppearanceAndLists(storeName) çağrılıyor.
                // O da createPopupContent(storeName) çağırıyor.
                // createPopupContent ise storeNotes[storeName]'i okuyor.
                // Teorik olarak çalışmalı.
                
                // ANCAK: Eğer kullanıcı "Tüm Değişiklikleri Kaydet" butonuna bastığında
                // popup kapanıp tekrar açılıyorsa sorun yok.
                // Eğer popup açık kalıyorsa (ki alert veriyor), içerik güncellenmeli.
                
                // KULLANICI ŞİKAYETİ: "tekrardan tıkladığım zaman girdiğim notu göstermiyor"
                // Bu, storeNotes'un düzgün kaydedilmediği anlamına gelebilir.
                
                // DÜZELTME: updateStoreAppearanceAndLists fonksiyonunu her durumda çağıralım veya popup içeriğini her durumda güncelleyelim.
                // Aşağıdaki mantıkta onlyNoteOrOrderChanged true ise updateStoreAppearanceAndLists ÇAĞRILIYOR.
                // False ise updateScheduleList ÇAĞRILIYOR.
                
                // HATA: !onlyNoteOrOrderChanged -> merchUpdated, regionUpdated veya datesAdded TRUE ise.
                // Bu durumda updateScheduleList çağrılıyor AMA updateStoreAppearanceAndLists ÇAĞRILMIYOR (doğrudan değil, ama updateAllMarkersAppearance çağrılıyor olabilir).
                
                // EĞER merchUpdated TRUE ise -> updateAllMarkersAppearance() çağrılıyor (yukarıda). Bu tüm markerları günceller.
                // EĞER regionUpdated TRUE ise -> Sadece filtreler güncelleniyor. Marker güncellenmiyor olabilir.
                // EĞER datesAdded TRUE ise -> Sadece schedule güncelleniyor.
                
                // Asıl sorun: Sadece not değiştiğinde (!merchUpdated && !regionUpdated && !datesAdded -> TRUE),
                // updateStoreAppearanceAndLists(storeName) çalışıyor.
                // Bu fonksiyon updateSingleMarkerAppearance(storeName) çağırıyor.
                // O da marker.getPopup().setContent(...) yapıyor.
                
                // Peki neden çalışmıyor?
                // noteInput değeri boş mu geliyor?
                
                updateStoreAppearanceAndLists(storeName);
            } else {
                keepMarkerVisibleStoreName = storeName;
                updateScheduleList();
                // Eğer updateAllMarkersAppearance çağrılmadıysa, popup içeriğini manuel güncelle
                if (!merchUpdated) {
                     updateSingleMarkerAppearance(storeName);
                }
            }
            try { 
                localStorage.setItem('savedSchedule', JSON.stringify(schedule));
                localStorage.setItem('savedDailyOrder', JSON.stringify(dailyOrder));
                localStorage.setItem('savedStoreNotes', JSON.stringify(storeNotes));
                localStorage.setItem('savedStores', JSON.stringify(stores));
                localStorage.setItem('savedEmptyDays', JSON.stringify(emptyDays));
            } catch (e) { 
                console.error('Otomatik kaydetme hatası:', e);
            }
            alert('Tüm değişiklikler kaydedildi.');
        };

        window.deleteDate = function (storeName, dateToDelete) {
            if (schedule[storeName]) {
                schedule[storeName] = schedule[storeName].filter(d => d !== dateToDelete);
                if (schedule[storeName].length === 0) {
                    delete schedule[storeName];
                }
                markers[storeName].getPopup().setContent(createPopupContent(storeName));
                updateStoreAppearanceAndLists(storeName);
            }
        };

        window.deleteStoreNote = function(storeName) {
            if (confirm('Notu silmek istediğinizden emin misiniz?')) {
                delete storeNotes[storeName];
                try { localStorage.setItem('savedStoreNotes', JSON.stringify(storeNotes)); } catch (e) { }
                
                const marker = markers[storeName];
                if (marker) {
                    marker.getPopup().setContent(createPopupContent(storeName));
                }
                // Not değişikliğini diğer listelere de yansıtmak gerekebilir ama genellikle not sadece popup'ta görünür
                // Yine de tutarlılık için updateStoreAppearanceAndLists çağrılabilir
                // Ancak bu işlem haritayı ve listeleri yeniden çizeceği için popup kapanabilir veya kullanıcı odağını kaybedebilir
                // Bu yüzden sadece popup içeriğini güncellemek daha iyi bir UX sağlar.
            }
        };

        function populateRegionFilter() {
            const regionFilter = document.getElementById('regionFilter');
            if (!regionFilter) return;

            const existingValue = regionFilter.value;
            Array.from(regionFilter.options).forEach(option => {
                if (option.value !== 'all') {
                    option.remove();
                }
            });
            const allRegions = new Set();
            stores.forEach(store => {
                if (store.Bölge) {
                    allRegions.add(store.Bölge);
                }
            });
            const sortedRegions = Array.from(allRegions).sort();
            sortedRegions.forEach(region => {
                const option = new Option(region, region);
                regionFilter.add(option);
            });
            if (Array.from(regionFilter.options).some(opt => opt.value === existingValue)) {
                regionFilter.value = existingValue;
            }
        }

        function populateFilters() {
            populateDateFilter();
            populateMerchFilter();
            populateRegionFilter();
            // YENİ: Şehir filtresini doldur
            populateCityFilter();
            // YENİ: Frekans filtresini doldur
            populateFrequencyFilter();
        }

        // YENİ: Frekans filtresini doldur
        function populateFrequencyFilter() {
            const frequencyFilter = document.getElementById('frequencyFilter');
            if (!frequencyFilter) return;

            const existingValue = frequencyFilter.value;
            Array.from(frequencyFilter.options).forEach(option => {
                if (option.value !== 'all') {
                    option.remove();
                }
            });

            // Tüm mağazaların frekans sayılarını topla
            const frequencyCounts = new Set();
            stores.forEach(store => {
                const storeName = store['Mağaza İsmi'];
                const frequencyCount = getStoreFrequencyCount(storeName);
                if (frequencyCount > 0) {
                    frequencyCounts.add(frequencyCount);
                }
            });

            // Frekansları sıralı şekilde ekle
            Array.from(frequencyCounts).sort((a, b) => a - b).forEach(freq => {
                const option = new Option(`${freq} Frekans`, freq);
                frequencyFilter.add(option);
            });

            if (Array.from(frequencyFilter.options).some(opt => opt.value === existingValue)) {
                frequencyFilter.value = existingValue;
            } else {
                frequencyFilter.value = 'all';
            }
        }

        function populateMerchFilter() {
            const merchFilter = document.getElementById('merchFilter');
            if (!merchFilter) return;

            const existingValue = merchFilter.value;
            Array.from(merchFilter.options).forEach(option => {
                if (option.value !== 'all') {
                    option.remove();
                }
            });
            const allMerchs = new Set();
            stores.forEach(store => {
                const merch = findMerchForStore(store['Mağaza İsmi']);
                if (merch) {
                    allMerchs.add(merch);
                }
            });
            const sortedMerchs = Array.from(allMerchs).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));
            sortedMerchs.forEach(merch => {
                const option = new Option(`Personel ${merch}`, merch);
                merchFilter.add(option);
            });
            if (Array.from(merchFilter.options).some(opt => opt.value === existingValue)) {
                merchFilter.value = existingValue;
            } else {
                merchFilter.value = 'all';
            }
        }

        function changeDateForGroup(oldDate, merch) {
            const newDateRaw = prompt(`'${oldDate} - Personel ${merch}' grubundaki tüm mağazalar için yeni günü girin (1-28 / 1. Gün):`);
            if (!newDateRaw || !isValidDate(newDateRaw)) {
                alert("Geçersiz gün formatı. Lütfen 1-28 arası bir gün girin (Pazar günleri planlanmaz).");
                return;
            }
            const convertedDate = convertDateFormat(newDateRaw);
            const storesInGroup = dailyOrder[oldDate] && dailyOrder[oldDate][merch] ? [...dailyOrder[oldDate][merch]] : [];
            if (storesInGroup.length === 0) {
                alert("Bu grupta mağaza bulunmuyor.");
                return;
            }

            // Daily order'ı yeni tarihe taşı (UI'da gün/grup senkron kalsın)
            dailyOrder[convertedDate] = dailyOrder[convertedDate] || {};
            const existingTarget = dailyOrder[convertedDate][merch] ? [...dailyOrder[convertedDate][merch]] : [];
            const merged = [...existingTarget];
            storesInGroup.forEach(s => { if (!merged.includes(s)) merged.push(s); });
            dailyOrder[convertedDate][merch] = merged;
            // Kaynak grubu temizle
            if (dailyOrder[oldDate] && dailyOrder[oldDate][merch]) {
                delete dailyOrder[oldDate][merch];
                if (Object.keys(dailyOrder[oldDate]).length === 0) {
                    delete dailyOrder[oldDate];
                }
            }

            let changedCount = 0;
            storesInGroup.forEach(storeName => {
                schedule[storeName] = (schedule[storeName] || []).filter(d => d !== oldDate);
                if (!schedule[storeName].includes(convertedDate)) {
                    schedule[storeName].push(convertedDate);
                }
                changedCount++;
            });
            alert(`${changedCount} mağaza '${newDateRaw}' olarak güncellendi.`);

            // Harita ikonlarını ve popup'u güncelle (asıl bug fix)
            storesInGroup.forEach(storeName => updateSingleMarkerAppearance(storeName));
            applyAllFilters();
        }

        // YENİ: Birbiriyle Değiştir (aynı personel içinde iki günü swapla)
        function swapDateGroup(sourceDate, merch) {
            const targetRaw = prompt(`'${sourceDate} - P.${merch}' grubunu hangi gün ile değiştirmek istiyorsunuz? (1-28 / 5 / 5. Gün):`);
            if (targetRaw === null) return;
            if (!targetRaw || !isValidDate(targetRaw)) {
                alert("Geçersiz gün formatı. (1-28 arası, Pazar günleri planlanmaz)");
                return;
            }
            const targetDate = convertDateFormat(targetRaw);
            if (targetDate === sourceDate) {
                alert("Kaynak ve hedef aynı olamaz.");
                return;
            }

            const listA = dailyOrder?.[sourceDate]?.[merch] ? [...dailyOrder[sourceDate][merch]] : [];
            const listB = dailyOrder?.[targetDate]?.[merch] ? [...dailyOrder[targetDate][merch]] : [];

            // schedule güncelle
            const touched = new Set();
            listA.forEach(storeName => {
                schedule[storeName] = (schedule[storeName] || []).filter(d => d !== sourceDate);
                if (!schedule[storeName].includes(targetDate)) schedule[storeName].push(targetDate);
                touched.add(storeName);
            });
            listB.forEach(storeName => {
                schedule[storeName] = (schedule[storeName] || []).filter(d => d !== targetDate);
                if (!schedule[storeName].includes(sourceDate)) schedule[storeName].push(sourceDate);
                touched.add(storeName);
            });

            // dailyOrder swap (sıra korunsun)
            dailyOrder[sourceDate] = dailyOrder[sourceDate] || {};
            dailyOrder[targetDate] = dailyOrder[targetDate] || {};
            dailyOrder[sourceDate][merch] = listB;
            dailyOrder[targetDate][merch] = listA;

            // Boş kalan grupları temizle
            if (dailyOrder[sourceDate][merch].length === 0) {
                delete dailyOrder[sourceDate][merch];
                if (Object.keys(dailyOrder[sourceDate]).length === 0) delete dailyOrder[sourceDate];
            }
            if (dailyOrder[targetDate][merch].length === 0) {
                delete dailyOrder[targetDate][merch];
                if (Object.keys(dailyOrder[targetDate]).length === 0) delete dailyOrder[targetDate];
            }

            // Marker güncelle
            touched.forEach(storeName => updateSingleMarkerAppearance(storeName));
            applyAllFilters();
            alert(`'${sourceDate}' ile '${targetDate}' günleri (P.${merch}) başarıyla değiştirildi.`);
        }

        // YENİ: Sağ listedeki gün grubundaki noktaları haritada seç
        function selectDayStores(date, merch) {
            const storesToSelect = dailyOrder?.[date]?.[merch] ? [...dailyOrder[date][merch]] : [];
            if (storesToSelect.length === 0) {
                alert("Bu grupta seçilecek mağaza bulunamadı.");
                return;
            }

            clearAllSelections();
            const bounds = [];

            storesToSelect.forEach(storeName => {
                const marker = markers[storeName];
                if (!marker) return;
                selectedStores.add(storeName);
                applySelectionVisual(storeName);
                bounds.push(marker.getLatLng());
            });

            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = `${selectedStores.size} mağaza seçildi.`;
            }
            updateBulkDeleteDateSelect();

            if (bounds.length > 0) {
                try {
                    map.fitBounds(L.latLngBounds(bounds), { padding: [40, 40] });
                } catch (e) { }
            }
        }

        function copyDate(sourceDate, merch) {
            const newDateRaw = prompt(`'${sourceDate} - P.${merch}' planını kopyalamak için yeni günü girin (1-28 / 1. Gün):`);
            if (newDateRaw === null) { return; }
            if (!newDateRaw || !isValidDate(newDateRaw)) {
                alert("Geçersiz gün formatı. (1-28 arası, Pazar günleri planlanmaz)");
                return;
            }
            if (newDateRaw === sourceDate) {
                alert("Kaynak ve hedef gün aynı olamaz. Lütfen farklı bir gün girin.");
                return;
            }
            const storesToCopy = dailyOrder[sourceDate]?.[merch];
            if (!storesToCopy || storesToCopy.length === 0) {
                alert("Bu grupta kopyalanacak mağaza bulunamadı.");
                return;
            }
            const convertedDate = convertDateFormat(newDateRaw);

            // GÜNCELLEME: Kopyalanan tarihlerin Excel çıktısında görünmesi için schedule nesnesini güncelle
            if (!dailyOrder[convertedDate]) {
                dailyOrder[convertedDate] = {};
            }
            dailyOrder[convertedDate][merch] = [...storesToCopy];

            let copiedCount = 0;
            storesToCopy.forEach(storeName => {
                if (schedule[storeName]) {
                    if (!schedule[storeName].includes(convertedDate)) {
                        schedule[storeName].push(convertedDate);
                        copiedCount++;
                    }
                } else {
                    // Eğer mağazanın schedule'ı yoksa oluştur
                    schedule[storeName] = [convertedDate];
                    copiedCount++;
                }
            });

            alert(`${sourceDate} planındaki ${copiedCount} mağaza, '${newDateRaw}' olarak başarıyla kopyalandı.`);
            applyAllFilters();
        }

        // GÜNCELLEME: "Boşalt" butonu kaldırıldı, "Tarih Sil" butonu işlevi değiştirildi
        function deleteDateGroup(date, merch) {
            if (!confirm(`'${date} - P.${merch}' planındaki tüm mağazaları boş güne taşımak istediğinizden emin misiniz? Tarihler silinecek ve mağazalar boş günlere taşınacak.`)) {
                return;
            }

            const storesToMove = dailyOrder[date]?.[merch];
            if (!storesToMove || storesToMove.length === 0) {
                alert("Bu grupta taşınacak mağaza bulunmuyor.");
                return;
            }

            // Boş gün ID'si oluştur
            let emptyDayId = "Boş Gün 1";
            let counter = 1;
            while (emptyDays[`Boş Gün ${counter}`]) {
                counter++;
            }
            emptyDayId = `Boş Gün ${counter}`;

            // Boş gün oluştur veya güncelle
            if (!emptyDays[emptyDayId]) {
                emptyDays[emptyDayId] = {};
            }
            emptyDays[emptyDayId][merch] = [...storesToMove];

            // Mağazaların tarihlerini temizle
            storesToMove.forEach(storeName => {
                if (schedule[storeName]) {
                    schedule[storeName] = schedule[storeName].filter(d => d !== date);
                    if (schedule[storeName].length === 0) {
                        delete schedule[storeName];
                    }
                }
                // Marker görünümünü güncelle
                updateSingleMarkerAppearance(storeName);
            });

            // DailyOrder'dan tarihi sil
            if (dailyOrder[date]) {
                delete dailyOrder[date][merch];
                if (Object.keys(dailyOrder[date]).length === 0) {
                    delete dailyOrder[date];
                }
            }

            alert(`'${date} - P.${merch}' planındaki ${storesToMove.length} mağaza '${emptyDayId}' boş gününe taşındı. Artık Gün Ata ile bu mağazalara yeni gün atayabilirsiniz.`);
            applyAllFilters();
        }

        function emptyDateGroup(date, merch) {
            // GÜNCELLEME: Bu fonksiyon artık kullanılmıyor, işlevi deleteDateGroup fonksiyonuna taşındı
            deleteDateGroup(date, merch);
        }

        function restoreEmptyDay(emptyDayId, merch) {
            if (!confirm(`'${emptyDayId} - P.${merch}' boş gününü tekrar aktif yapmak istediğinizden emin misiniz?`)) {
                return;
            }

            const storesInEmptyDay = emptyDays[emptyDayId]?.[merch];
            if (!storesInEmptyDay || storesInEmptyDay.length === 0) {
                alert("Bu boş günde mağaza bulunmuyor.");
                return;
            }

            if (emptyDays[emptyDayId]) {
                delete emptyDays[emptyDayId][merch];
                if (Object.keys(emptyDays[emptyDayId]).length === 0) {
                    delete emptyDays[emptyDayId];
                }
            }

            alert(`'${emptyDayId} - P.${merch}' boş günü tekrar aktif hale getirildi. Artık bu güne mağaza atayabilirsiniz.`);
            applyAllFilters();
        }

        function assignDateToEmptyDay(emptyDayId, merch) {
            const newDate = prompt(`'${emptyDayId} - P.${merch}' için yeni gün girin (1-28 / 1. Gün):`);
            if (!newDate || !isValidDate(newDate)) {
                alert("Geçersiz gün formatı. (1-28 arası, Pazar günleri planlanmaz)");
                return;
            }

            const convertedDate = convertDateFormat(newDate);
            const storesInEmptyDay = emptyDays[emptyDayId]?.[merch];

            if (!storesInEmptyDay || storesInEmptyDay.length === 0) {
                alert("Bu boş günde mağaza bulunmuyor.");
                return;
            }

            if (!dailyOrder[convertedDate]) {
                dailyOrder[convertedDate] = {};
            }
            dailyOrder[convertedDate][merch] = [...storesInEmptyDay];

            storesInEmptyDay.forEach(storeName => {
                if (!schedule[storeName]) {
                    schedule[storeName] = [];
                }
                if (!schedule[storeName].includes(convertedDate)) {
                    schedule[storeName].push(convertedDate);
                }
            });

            if (emptyDays[emptyDayId]) {
                delete emptyDays[emptyDayId][merch];
                if (Object.keys(emptyDays[emptyDayId]).length === 0) {
                    delete emptyDays[emptyDayId];
                }
            }

            storesInEmptyDay.forEach(storeName => {
                updateSingleMarkerAppearance(storeName);
            });

            alert(`'${emptyDayId}' için '${newDate}' günü atandı. ${storesInEmptyDay.length} mağaza bu güne taşındı.`);
            applyAllFilters();
        }

        function removeStoreFromEmptyDay(storeName, emptyDayId, merch, event) {
            event.stopPropagation();

            if (!confirm(`'${storeName}' mağazasını '${emptyDayId}' boş gününden kaldırmak istediğinizden emin misiniz?`)) {
                return;
            }

            if (emptyDays[emptyDayId] && emptyDays[emptyDayId][merch]) {
                emptyDays[emptyDayId][merch] = emptyDays[emptyDayId][merch].filter(store => store !== storeName);
                if (emptyDays[emptyDayId][merch].length === 0) {
                    delete emptyDays[emptyDayId][merch];
                    if (Object.keys(emptyDays[emptyDayId]).length === 0) {
                        delete emptyDays[emptyDayId];
                    }
                }
            }

            updateSingleMarkerAppearance(storeName);
            applyAllFilters();
        }

        function removeStoreFromDate(storeName, date, event) {
            event.stopPropagation();

            if (!confirm(`'${storeName}' mağazasını '${date}' planından kaldırmak istediğinizden emin misiniz?`)) {
                return;
            }

            if (schedule[storeName]) {
                schedule[storeName] = schedule[storeName].filter(d => d !== date);
                if (schedule[storeName].length === 0) {
                    delete schedule[storeName];
                }
            }

            applyAllFilters();
        }

        function updateSummaryInfo() {
            summaryCalculationId++;
            const thisCalculationId = summaryCalculationId;
            const summaryDiv = document.getElementById('summary-bar');
            if (!summaryDiv) return;

            const selectedRegion = document.getElementById('regionFilter')?.value || 'all';
            const selectedDate = document.getElementById('dateFilter')?.value || 'all';
            const selectedMerch = document.getElementById('merchFilter')?.value || 'all';
            // YENİ: Yeni filtreleri al
            const selectedStore = document.getElementById('storeSearchFilter')?.value || '';
            const selectedCity = document.getElementById('cityFilter')?.value || 'all';
            const selectedDistrict = document.getElementById('districtFilter')?.value || 'all';

            let totalVisits = 0;
            let totalStoreDuration = 0;
            const uniqueStores = new Set();
            const routePromises = [];

            if (selectedDate === 'empty_days') {
                let emptyStoresCount = 0;
                for (let emptyDayId in emptyDays) {
                    for (let merch in emptyDays[emptyDayId]) {
                        if (selectedMerch !== 'all' && merch !== selectedMerch) continue;
                        const storesInEmptyDay = emptyDays[emptyDayId][merch];
                        storesInEmptyDay.forEach(storeName => {
                            const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                            if (!storeData) return;
                            const storeRegion = storeData.Bölge || "";
                            const storeCity = storeData.İl || "";
                            const storeDistrict = storeData.İlçe || "";
                            // YENİ: Yeni filtre kontrolleri
                            const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                            const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                            const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);

                            if (selectedRegion === 'all' || storeRegion === selectedRegion) {
                                if (storeNameMatch && cityMatch && districtMatch) {
                                    emptyStoresCount++;
                                    uniqueStores.add(storeData['Mağaza İsmi']);
                                }
                            }
                        });
                    }
                }

                summaryDiv.innerHTML = `
                <div class="summary-item">Boş Günlerdeki Mağaza Sayısı: <span>${emptyStoresCount}</span></div>
                <div class="summary-item">Toplam Boş Gün: <span>${Object.keys(emptyDays).length}</span></div>
            `;
                return;
            }

            for (const date in dailyOrder) {
                if (selectedDate !== 'all' && date !== selectedDate) continue;
                for (const merch in dailyOrder[date]) {
                    if (selectedMerch !== 'all' && merch !== selectedMerch) continue;
                    const storesOnDateAndMerch = dailyOrder[date][merch];
                    const visibleStoresInRoute = [];
                    storesOnDateAndMerch.forEach(storeName => {
                        const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                        if (!storeData) return;
                        const storeRegion = storeData.Bölge || "";
                        const storeCity = storeData.İl || "";
                        const storeDistrict = storeData.İlçe || "";
                        // YENİ: Yeni filtre kontrolleri
                        const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                        const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                        const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);

                        if ((selectedRegion === 'all' || storeRegion === selectedRegion) && storeNameMatch && cityMatch && districtMatch) {
                            visibleStoresInRoute.push(storeData);
                            totalVisits++;
                            uniqueStores.add(storeData['Mağaza İsmi']);

                            if (storeData['Mağaza İçin Süre'] && !isNaN(parseFloat(storeData['Mağaza İçin Süre']))) {
                                totalStoreDuration += parseFloat(storeData['Mağaza İçin Süre']);
                            }
                        }
                    });
                    if (visibleStoresInRoute.length >= 2) {
                        const points = visibleStoresInRoute.map(s => ({ lat: s.Enlem, lon: s.Boylam }));
                        const promise = fetch('/calculate_multi_point_route', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ points: points })
                        }).then(res => res.json());
                        routePromises.push(promise);
                    }
                }
            }

            summaryDiv.innerHTML = `
            <div class="summary-item">Filtrelenen Mağaza Sayısı: <span>${uniqueStores.size}</span></div>
            <div class="summary-item">Toplam Ziyaret Sayısı: <span>${totalVisits}</span></div>
            <div class="summary-item">Toplam Mağaza Süresi: <span>${totalStoreDuration.toFixed(2)} dk</span></div>
            <div class="summary-item">Toplam KM: <span>Hesaplanıyor...</span></div>
            <div class="summary-item">Toplam Yol Süresi: <span>Hesaplanıyor...</span></div>
            <div class="summary-item">Genel Toplam Süre: <span>Hesaplanıyor...</span></div>
        `;

            Promise.all(routePromises).then(results => {
                if (thisCalculationId !== summaryCalculationId) { return; }
                let totalTravelKm = 0;
                let totalTravelMin = 0;
                results.forEach(data => {
                    if (data.status === 'success') {
                        totalTravelKm += data.km;
                        totalTravelMin += data.min;
                    }
                });

                const grandTotalMin = totalStoreDuration + totalTravelMin;
                const grandTotalHours = (grandTotalMin / 60).toFixed(2);
                const totalStoreHours = (totalStoreDuration / 60).toFixed(2);
                const totalTravelHours = (totalTravelMin / 60).toFixed(2);

                summaryDiv.innerHTML = `
                <div class="summary-item">Filtrelenen Mağaza Sayısı: <span>${uniqueStores.size}</span></div>
                <div class="summary-item">Toplam Ziyaret Sayısı: <span>${totalVisits}</span></div>
                <div class="summary-item">Toplam Mağaza Süresi: <span>${totalStoreDuration.toFixed(2)} dk (${totalStoreHours} sa)</span></div>
                <div class="summary-item">Toplam KM: <span>${totalTravelKm.toFixed(2)} km</span></div>
                <div class="summary-item">Toplam Yol Süresi: <span>${totalTravelMin.toFixed(2)} dk (${totalTravelHours} sa)</span></div>
                <div class="summary-item">Genel Toplam Süre: <span>${grandTotalMin.toFixed(2)} dk (${grandTotalHours} sa)</span></div>
            `;
            }).catch(error => {
                console.error("Özet rota hesaplama hatası:", error);
                summaryDiv.innerHTML += "<div>Rota hesaplanırken hata oluştu.</div>";
            });
        }

        function updateScheduleList() {
            const listDiv = document.getElementById("schedule-list");
            if (!listDiv) return;

            listDiv.innerHTML = "";
            const selectedMerch = document.getElementById('merchFilter')?.value || 'all';
            const selectedRegion = document.getElementById('regionFilter')?.value || 'all';
            const selectedDate = document.getElementById('dateFilter')?.value || 'all';
            // YENİ: Yeni filtreleri al
            const selectedStore = document.getElementById('storeSearchFilter')?.value || '';
            const selectedCity = document.getElementById('cityFilter')?.value || 'all';
            const selectedDistrict = document.getElementById('districtFilter')?.value || 'all';

            if (selectedDate === 'empty_days') {
                if (Object.keys(emptyDays).length === 0) {
                    listDiv.innerHTML = "<p>Boş gün bulunmuyor.</p>";
                    return;
                }

                Object.keys(emptyDays).forEach(emptyDayId => {
                    const emptyMerchGroups = emptyDays[emptyDayId];
                    const sortedEmptyMerchs = Object.keys(emptyMerchGroups).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));

                    sortedEmptyMerchs.forEach(merch => {
                        if (selectedMerch !== 'all' && merch !== selectedMerch) return;

                        const storesInEmptyDay = emptyMerchGroups[merch];
                        const selectedFrequency = document.getElementById('frequencyFilter')?.value || 'all';
                        const filteredStores = storesInEmptyDay.filter(storeName => {
                            const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                            const storeRegion = storeData?.Bölge || '';
                            const storeCity = storeData?.İl || '';
                            const storeDistrict = storeData?.İlçe || '';
                            // YENİ: Yeni filtre kontrolleri
                            const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                            const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                            const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);
                            const storeFrequencyCount = getStoreFrequencyCount(storeName);
                            const frequencyMatch = (selectedFrequency === 'all') || (storeFrequencyCount > 0 && storeFrequencyCount === parseInt(selectedFrequency));

                            return (selectedRegion === 'all' || storeRegion === selectedRegion) && storeNameMatch && cityMatch && districtMatch && frequencyMatch;
                        });

                        if (filteredStores.length === 0) return;

                        const header = document.createElement("div");
                        header.className = "empty-date-group-header";
                        // GÜNCELLEME: "Aktif Et" butonu kaldırıldı
                        header.innerHTML = `<span>${emptyDayId} - P.${merch} (${filteredStores.length} Mağaza)</span>
                                        <div class="header-buttons">
                                            <button class="header-btn" onclick="assignDateToEmptyDay('${emptyDayId}', '${merch}')" style="background-color:#28a745; color:white;">Gün Ata</button>
                                            <button class="header-btn" onclick="deleteDateGroup('${emptyDayId}', '${merch}')" style="background-color:#ff6b6b; color:white;">Sil</button>
                                        </div>`;
                        listDiv.appendChild(header);

                        const storeListContainer = document.createElement("div");
                        storeListContainer.className = 'store-list';
                        storeListContainer.id = `empty-${emptyDayId}-${merch}`;
                        listDiv.appendChild(storeListContainer);

                        filteredStores.forEach(storeName => {
                            const item = document.createElement("div");
                            item.className = "schedule-item";
                            item.dataset.storeName = storeName;
                            item.innerHTML = `<span>${storeName}</span><button class="delete-store-btn" onclick="removeStoreFromEmptyDay('${storeName}', '${emptyDayId}', '${merch}', event)">×</button>`;

                            item.addEventListener('click', () => {
                                const marker = markers[storeName];
                                if (marker) { map.flyTo(marker.getLatLng(), 16); marker.openPopup(); }
                            });
                            storeListContainer.appendChild(item);
                        });
                    });
                });

                if (listDiv.innerHTML === "") {
                    listDiv.innerHTML = "<p>Filtreye uygun boş gün bulunamadı.</p>";
                }
                return;
            }

            const grouped = {};
            const selectedFrequency = document.getElementById('frequencyFilter')?.value || 'all';
            for (const storeName in schedule) {
                const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                const merch = findMerchForStore(storeName) || 'Belirtilmemiş';
                const storeRegion = store?.Bölge || '';
                const storeCity = store?.İl || '';
                const storeDistrict = store?.İlçe || '';
                // YENİ: Yeni filtre kontrolleri
                const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);
                const storeFrequencyCount = getStoreFrequencyCount(storeName);
                const frequencyMatch = (selectedFrequency === 'all') || (storeFrequencyCount > 0 && storeFrequencyCount === parseInt(selectedFrequency));

                if ((selectedMerch !== 'all' && merch !== selectedMerch) || !storeNameMatch || !cityMatch || !districtMatch || !frequencyMatch) { continue; }
                if (selectedRegion !== 'all' && storeRegion !== selectedRegion) { continue; }

                schedule[storeName].forEach(date => {
                    if (selectedDate !== 'all' && date !== selectedDate) { return; }
                    if (!grouped[date]) grouped[date] = {};
                    if (!grouped[date][merch]) grouped[date][merch] = [];
                    grouped[date][merch].push(storeName);
                });
            }

            const newDailyOrder = {};
            for (const date in grouped) {
                newDailyOrder[date] = {};
                for (const merch in grouped[date]) {
                    const currentStores = grouped[date][merch];
                    const oldOrder = (dailyOrder[date] && dailyOrder[date][merch]) ? dailyOrder[date][merch] : [];
                    const preservedOrder = oldOrder.filter(store => currentStores.includes(store));
                    const addedStores = currentStores.filter(store => !preservedOrder.includes(store));
                    newDailyOrder[date][merch] = [...preservedOrder, ...addedStores.sort()];
                }
            }
            dailyOrder = newDailyOrder;

            const sortedDates = Object.keys(dailyOrder).sort(compareDates);

            if (sortedDates.length === 0) {
                listDiv.innerHTML = "<p>Filtreye uygun atama bulunamadı.</p>";
            } else {
                sortedDates.forEach(date => {
                    const merchGroups = dailyOrder[date];
                    const sortedMerchs = Object.keys(merchGroups).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));
                    sortedMerchs.forEach(merch => {
                        const storesOnDateAndMerch = merchGroups[merch];
                        const appearance = getAppearanceForDate(date);
                        const header = document.createElement("div");
                        header.className = "date-group-header";
                        // GÜNCELLEME: "Boşalt" butonu kaldırıldı, sadece "Tarih Sil" butonu kaldı
                        header.innerHTML = `<span>${date} - P.${merch} (${storesOnDateAndMerch.length} Mağaza)</span>
                                        <div class="header-buttons">
                                            <button class="header-btn" onclick="selectDayStores('${date}', '${merch}')" style="background-color:#111827; color:white;">Noktaları Seç</button>
                                            <button class="header-btn" onclick="swapDateGroup('${date}', '${merch}')" style="background-color:#f59e0b; color:white;">Birbiriyle Değiştir</button>
                                            <button class="header-btn" onclick="deleteDateGroup('${date}', '${merch}')" style="background-color:#ff6b6b; color:white;">Tarih Sil</button>
                                            <button class="header-btn" onclick="copyDate('${date}', '${merch}')">Tarihi Kopyala</button>
                                            <button class="header-btn" onclick="changeDateForGroup('${date}', '${merch}')">Tarihi Değiştir</button>
                                            <button class="header-btn" onclick="calculateDateRoute('${date}', '${merch}')">Süre/Rota Hesapla</button>
                                        </div>`;
                        header.style.backgroundColor = appearance.bg;
                        listDiv.appendChild(header);
                        const storeListContainer = document.createElement("div");
                        storeListContainer.className = 'store-list';
                        storeListContainer.id = `list-${date}-${merch}`;
                        listDiv.appendChild(storeListContainer);
                        storesOnDateAndMerch.forEach(storeName => {
                            const item = document.createElement("div");
                            item.className = "schedule-item";
                            item.dataset.storeName = storeName;

                            // Gün farkı ihlali kontrolü - kırmızı yap
                            if (hasFrequencyViolation(storeName)) {
                                item.style.backgroundColor = '#FF0000';
                                item.style.color = 'white';
                            } else {
                                // Talep Frekansına göre renklendirme
                                const talepFrekansColor = getColorByTalepFrekans(storeName);
                                if (talepFrekansColor) {
                                    item.style.backgroundColor = talepFrekansColor;
                                }
                            }

                            // Eski class'ları kaldır (artık inline style kullanıyoruz)
                            if (hasLowFrequency(storeName)) {
                                // Eğer Talep Frekansı eksikse, renklendirme yapılmışsa üzerine yazma
                                if (!getColorByTalepFrekans(storeName) && !hasFrequencyViolation(storeName)) {
                                    item.style.backgroundColor = '#fff9c4';
                                }
                            }

                            item.innerHTML = `<span>${storeName}</span><button class="delete-store-btn" onclick="removeStoreFromDate('${storeName}', '${date}', event)">×</button>`;

                            item.addEventListener('click', () => {
                                const marker = markers[storeName];
                                if (marker) { map.flyTo(marker.getLatLng(), 16); marker.openPopup(); }
                            });
                            storeListContainer.appendChild(item);
                        });
                    });
                });
            }

            document.querySelectorAll('.store-list').forEach(listEl => {
                new Sortable(listEl, {
                    animation: 150,
                    onEnd: function (evt) {
                        const [_, date, merch] = evt.target.id.split('-');
                        dailyOrder[date][merch] = Array.from(evt.target.children).map(item => item.dataset.storeName);
                    }
                });
            });

            populateDateFilter();
            populateFrequencyFilter();
            updateSummaryInfo();
        }

        function populateDateFilter() {
            const dateFilter = document.getElementById("dateFilter");
            if (!dateFilter) return;

            const currentValue = dateFilter.value;
            Array.from(dateFilter.options).forEach(option => {
                if (option.value !== 'all' && option.value !== 'empty_days') {
                    option.remove();
                }
            });
            const allDates = [...new Set([].concat(...Object.values(schedule)))];

            const sortedDates = allDates.sort(compareDates);

            sortedDates.forEach(date => {
                const option = new Option(date, date);
                dateFilter.add(option);
            });
            if (Array.from(dateFilter.options).some(opt => opt.value === currentValue)) {
                dateFilter.value = currentValue;
            } else {
                dateFilter.value = "all";
            }
        }

        function applyAllFilters() {
            markerClusterGroup.clearLayers();
            nonClusteredGroup.clearLayers();
            if (map.hasLayer(markerClusterGroup)) { map.removeLayer(markerClusterGroup); }
            if (map.hasLayer(nonClusteredGroup)) { map.removeLayer(nonClusteredGroup); }

            const selectedDate = document.getElementById('dateFilter')?.value || 'all';
            const selectedMerch = document.getElementById('merchFilter')?.value || 'all';
            const selectedRegion = document.getElementById('regionFilter')?.value || 'all';
            // YENİ: Yeni filtreleri al
            const selectedStore = document.getElementById('storeSearchFilter')?.value || '';
            const selectedCity = document.getElementById('cityFilter')?.value || 'all';
            const selectedDistrict = document.getElementById('districtFilter')?.value || 'all';
            const selectedFrequency = document.getElementById('frequencyFilter')?.value || 'all';

            // GÜNCELLEME: Herhangi bir filtre aktifse gruplamayı kaldır, sadece bölge filtresi değil
            const anyFilterActive = selectedRegion !== 'all' || selectedDate !== 'all' || selectedMerch !== 'all' ||
                selectedStore !== '' || selectedCity !== 'all' || selectedDistrict !== 'all' || selectedFrequency !== 'all';

            if (selectedDate === 'empty_days') {
                for (const storeName in markers) {
                    const marker = markers[storeName];
                    const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                    const storeMerch = findMerchForStore(storeName);
                    const storeRegion = storeData?.Bölge || "";
                    const storeCity = storeData?.İl || "";
                    const storeDistrict = storeData?.İlçe || "";
                    // YENİ: Yeni filtre kontrolleri
                    const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                    const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                    const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);
                    const storeFrequencyCount = getStoreFrequencyCount(storeName);
                    const frequencyMatch = (selectedFrequency === 'all') || (storeFrequencyCount > 0 && storeFrequencyCount === parseInt(selectedFrequency));

                    let isInEmptyDays = false;
                    for (let emptyDayId in emptyDays) {
                        for (let merch in emptyDays[emptyDayId]) {
                            if (emptyDays[emptyDayId][merch].includes(storeName)) {
                                isInEmptyDays = true;
                                break;
                            }
                        }
                        if (isInEmptyDays) break;
                    }

                    const merchMatch = (selectedMerch === 'all') || (storeMerch === selectedMerch);
                    const regionMatch = (selectedRegion === 'all') || (storeRegion === selectedRegion);

                    if (isInEmptyDays && merchMatch && regionMatch && storeNameMatch && cityMatch && districtMatch) {
                        // GÜNCELLEME: Herhangi bir filtre aktifse nonClusteredGroup kullan
                        if (anyFilterActive) { nonClusteredGroup.addLayer(marker); }
                        else { markerClusterGroup.addLayer(marker); }
                    }
                }
            } else {
                for (const storeName in markers) {
                    const marker = markers[storeName];
                    const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                    const storeDates = schedule[storeName] || [];
                    const storeMerch = findMerchForStore(storeName);
                    const storeRegion = storeData?.Bölge || "";
                    const storeCity = storeData?.İl || "";
                    const storeDistrict = storeData?.İlçe || "";
                    // YENİ: Yeni filtre kontrolleri
                    const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                    const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                    const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);
                    const storeFrequencyCount = getStoreFrequencyCount(storeName);
                    const frequencyMatch = (selectedFrequency === 'all') || (storeFrequencyCount > 0 && storeFrequencyCount === parseInt(selectedFrequency));

                    const dateMatch = (selectedDate === 'all') || storeDates.includes(selectedDate);
                    const merchMatch = (selectedMerch === 'all') || (storeMerch === selectedMerch);
                    const regionMatch = (selectedRegion === 'all') || (storeRegion === selectedRegion);

                    if (dateMatch && merchMatch && regionMatch && storeNameMatch && cityMatch && districtMatch && frequencyMatch) {
                        // GÜNCELLEME: Herhangi bir filtre aktifse nonClusteredGroup kullan
                        if (anyFilterActive) { nonClusteredGroup.addLayer(marker); }
                        else { markerClusterGroup.addLayer(marker); }
                    }
                }
            }

            // Not kaydedilen simge kaybolmasın: az önce not kaydedilen mağazayı her zaman haritada tut
            if (keepMarkerVisibleStoreName && markers[keepMarkerVisibleStoreName]) {
                const keepMarker = markers[keepMarkerVisibleStoreName];
                if (!markerClusterGroup.hasLayer(keepMarker) && !nonClusteredGroup.hasLayer(keepMarker)) {
                    if (anyFilterActive) { nonClusteredGroup.addLayer(keepMarker); }
                    else { markerClusterGroup.addLayer(keepMarker); }
                }
                keepMarkerVisibleStoreName = null;
            }

            // GÜNCELLEME: Herhangi bir filtre aktifse nonClusteredGroup kullan
            if (anyFilterActive) { map.addLayer(nonClusteredGroup); }
            else { map.addLayer(markerClusterGroup); }

            updateScheduleList();
        }

        function calculateAndDrawRoute(points, color = 'blue', totalStopDuration = 0, targetLayer = routeLayer) {
            fetch('/calculate_multi_point_route', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ points: points })
            }).then(response => response.json()).then(data => {
                if (data.status === 'success') {
                    const routeLine = L.polyline(data.path, { color: color, weight: 5, opacity: 0.8 }).addTo(targetLayer);
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                    const travelMin = data.min;
                    const grandTotalMin = travelMin + totalStopDuration;
                    const tooltipContent = `
                    <b>Yol Süresi:</b> ${travelMin.toFixed(2)} dk<br>
                    <b>Mağaza Süresi:</b> ${totalStopDuration.toFixed(2)} dk<br>
                    <b>Toplam Süre:</b> ${grandTotalMin.toFixed(2)} dk<br>
                    <b>Toplam Mesafe:</b> ${data.km} km
                `;
                    routeLine.bindTooltip(tooltipContent, { permanent: true, direction: 'center', className: 'route-tooltip' }).openTooltip();
                } else {
                    // Son çare: kuş uçuşu (frontend fallback)
                    try {
                        const fallbackPath = points.map(p => [p.lat, p.lon]);
                        const routeLine = L.polyline(fallbackPath, { color: color, weight: 4, opacity: 0.7, dashArray: '6 8' }).addTo(targetLayer);
                        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                        const toRad = (x) => x * Math.PI / 180;
                        const havKm = (a, b) => {
                            const R = 6371;
                            const dLat = toRad(b[0] - a[0]);
                            const dLon = toRad(b[1] - a[1]);
                            const lat1 = toRad(a[0]);
                            const lat2 = toRad(b[0]);
                            const sinDLat = Math.sin(dLat / 2);
                            const sinDLon = Math.sin(dLon / 2);
                            const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
                            return 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
                        };
                        let km = 0;
                        for (let i = 0; i < fallbackPath.length - 1; i++) km += havKm(fallbackPath[i], fallbackPath[i + 1]);
                        const travelMin = km * 2;
                        const grandTotalMin = travelMin + totalStopDuration;
                        const tooltipContent = `
                        <b>Yol Süresi:</b> ${travelMin.toFixed(2)} dk (kuş uçuşu)<br>
                        <b>Mağaza Süresi:</b> ${totalStopDuration.toFixed(2)} dk<br>
                        <b>Toplam Süre:</b> ${grandTotalMin.toFixed(2)} dk<br>
                        <b>Toplam Mesafe:</b> ${km.toFixed(2)} km (kuş uçuşu)
                    `;
                        routeLine.bindTooltip(tooltipContent, { permanent: true, direction: 'center', className: 'route-tooltip' }).openTooltip();
                    } catch (e) {
                        alert('Rota hesaplanamadı: ' + (data?.message || 'Bilinmeyen hata'));
                    }
                }
            }).catch(err => {
                // Ağ hatası vs: kuş uçuşu fallback
                try {
                    const fallbackPath = points.map(p => [p.lat, p.lon]);
                    const routeLine = L.polyline(fallbackPath, { color: color, weight: 4, opacity: 0.7, dashArray: '6 8' }).addTo(targetLayer);
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                } catch (e) {
                    alert('Rota hesaplanamadı: ' + String(err));
                }
            });
        }

        window.calculateDateRoute = function (date, merch) {
            const storesToRoute = (dailyOrder[date] && dailyOrder[date][merch]) ? dailyOrder[date][merch] : [];
            if (storesToRoute.length < 2) {
                alert("Rota çizmek için en az 2 mağaza gereklidir.");
                return;
            }
            let totalStopDuration = 0;
            const points = storesToRoute.map(storeName => {
                const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                if (store && store['Mağaza İçin Süre'] && !isNaN(parseFloat(store['Mağaza İçin Süre']))) {
                    totalStopDuration += parseFloat(store['Mağaza İçin Süre']);
                }
                const latlng = markers[storeName].getLatLng();
                return { lat: latlng.lat, lon: latlng.lng };
            });
            calculateAndDrawRoute(points, 'blue', totalStopDuration);
        };

        // KARE SEÇİM MODU FONKSİYONLARI - SADECE SHIFT TUŞU İLE ÇALIŞACAK

        // Yeni: Kare seçimini temizleme fonksiyonu
        function clearRectangleSelection() {
            // Seçilen mağazaların işaretlerini temizle
            // ÖNEMLİ: önce listeyi al, set'i temizle, sonra ikonları güncelle (yoksa seçili sayılır ve halka kalır)
            const toClear = Array.from(selectedStores);
            selectedStores.clear();
            toClear.forEach(storeName => {
                applySelectionVisual(storeName);
            });
            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = "0 mağaza seçildi.";
            }
        }

        // Yeni: Kare seçim modunu başlat (shift tuşu bekler)
        function initializeRectangleSelection() {
            // Shift tuşu event listener'larını ekle
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            console.log("Kare seçim modu başlatıldı. Shift tuşuna basılı tutarak kare çizebilirsiniz.");
        }

        // Yeni: Kare seçim modunu durdur
        function stopRectangleSelection() {
            // Mouse event listener'ları temizle
            map.off('mousedown', onMapMouseDown);
            map.off('mousemove', onMapMouseMove);
            map.off('mouseup', onMapMouseUp);

            // Eğer çizim devam ediyorsa temizle
            if (rectangleLayer) {
                map.removeLayer(rectangleLayer);
                rectangleLayer = null;
            }

            if (map.getContainer()) {
                map.getContainer().style.cursor = '';
            }
            rectangleDrawing = false;
            rectangleStartPoint = null;

            console.log("Kare seçim modu durduruldu.");
        }

        // Yeni: Klavye event handler'ları - SADECE SHIFT TUŞU İLE ÇALIŞACAK
        function handleKeyDown(e) {
            // ESC tuşuna basılırsa çizimi zorla iptal et ve temizle
            if (e.key === 'Escape') {
                console.log("ESC basıldı, çizim iptal ediliyor.");
                stopRectangleSelection();
                clearRectangleSelection();
                // YENİ: Ctrl ile seçilen noktaları da temizle
                try { clearCtrlRouteSession(); } catch (err) { }
                // Eğer harita üzerinde kalmış bir layer varsa onu da manuel temizle
                if (rectangleLayer && map.hasLayer(rectangleLayer)) {
                    map.removeLayer(rectangleLayer);
                    rectangleLayer = null;
                }
                if (map.getContainer()) {
                    map.getContainer().style.cursor = '';
                }
                return;
            }

            // Sadece Shift tuşu ile çalışsın
            if (e.key === 'Shift' && !rectangleDrawing && !e.repeat) {
                console.log("Shift tuşu basıldı, kare çizim modu aktif.");
                startRectangleDrawing();
            }
        }

        function handleKeyUp(e) {
            // Sadece Shift tuşu ile çalışsın
            if (e.key === 'Shift' && rectangleDrawing) {
                console.log("Shift tuşu bırakıldı, kare çizim modu pasif.");
                stopRectangleDrawing();
            }
        }

        // Yeni: Kare çizimi başlat
        function startRectangleDrawing() {
            if (rectangleDrawing) return; // Zaten çizim modunda ise tekrar başlatma

            rectangleDrawing = true;

            // Mouse event listener'larını ekle
            map.on('mousedown', onMapMouseDown);
            map.on('mousemove', onMapMouseMove);
            map.on('mouseup', onMapMouseUp);

            // Map dışına çıkıp mouseup olursa takılı kalmasın
            document.addEventListener('mouseup', onGlobalMouseUp, { once: true });

            if (map.getContainer()) {
                map.getContainer().style.cursor = 'crosshair';
            }

            console.log("Kare çizim modu aktif, haritada kare çizebilirsiniz.");
        }

        function stopRectangleDrawing() {
            // Mouse event listener'ları temizle
            map.off('mousedown', onMapMouseDown);
            map.off('mousemove', onMapMouseMove);
            map.off('mouseup', onMapMouseUp);

            rectangleDrawing = false;
            rectangleStartPoint = null;

            if (rectangleLayer) {
                try { map.removeLayer(rectangleLayer); } catch (e) { }
                rectangleLayer = null;
            }

            if (map.getContainer()) {
                map.getContainer().style.cursor = '';
            }
        }

        function onGlobalMouseUp() {
            // Mouseup harita dışında olsa bile çizimi kapat
            if (rectangleDrawing) {
                stopRectangleDrawing();
            }
        }

        // Mouse event fonksiyonları
        function onMapMouseDown(e) {
            if (!rectangleDrawing) return;

            rectangleStartPoint = e.latlng;

            // Rectangle layer oluştur
            rectangleLayer = L.rectangle([rectangleStartPoint, rectangleStartPoint], {
                color: '#007bff',
                weight: 2,
                fillColor: '#007bff',
                fillOpacity: 0.2
            }).addTo(map);

            console.log("Kare çizimi başlatıldı:", rectangleStartPoint);
        }

        function onMapMouseMove(e) {
            if (!rectangleDrawing || !rectangleStartPoint || !rectangleLayer) return;

            // Shift bırakıldıysa (keyup kaçırıldıysa) takılmasın
            if (e?.originalEvent && !e.originalEvent.shiftKey) {
                stopRectangleDrawing();
                return;
            }

            // Rectangle'ı güncelle
            const bounds = L.latLngBounds(rectangleStartPoint, e.latlng);
            rectangleLayer.setBounds(bounds);
        }

        function onMapMouseUp(e) {
            if (!rectangleDrawing || !rectangleStartPoint || !rectangleLayer) return;

            // Hata olsa bile en sonda rectangleLayer'ı temizlemeyi garanti altına alıyoruz
            try {
                const bounds = rectangleLayer.getBounds();
                let count = 0;

                // Seçilen alandaki mağazaları bul
                for (const storeName in markers) {
                    const marker = markers[storeName];

                    // Marker şu an aktif olan katman gruplarından birinde var mı?
                    const isVisible = markerClusterGroup.hasLayer(marker) || nonClusteredGroup.hasLayer(marker);

                    if (marker && isVisible && bounds.contains(marker.getLatLng())) {
                        selectedStores.add(storeName);
                        applySelectionVisual(storeName);
                        count++;
                    }
                }

                // Seçim sayısını güncelle
                if (selectedCountDisplay) {
                    selectedCountDisplay.textContent = `${count} mağaza seçildi.`;
                }

                if (count > 0) {
                    setTimeout(() => {
                        console.log(`${count} mağaza seçildi (Filtrelenenler arasından).`);
                    }, 100);
                } else {
                    setTimeout(() => {
                        console.log("Seçilen alanda filtreye uygun mağaza bulunamadı.");
                    }, 100);
                }

                console.log("Kare çizimi tamamlandı, seçilen mağaza sayısı:", count);

                // Seçimden sonra tarih listesini güncelle
                updateBulkDeleteDateSelect();

            } catch (error) {
                console.error("Seçim sırasında hata oluştu:", error);
            } finally {
                // Seçim bitince çizimi güvenli kapat (Shift keyup kaçsa bile takılmasın)
                stopRectangleDrawing();
            }
        }

        // Toplu seçim modu işlevi
        function handleMultiSelect(storeName) {
            if (!markers[storeName]) return;
            const marker = markers[storeName];
            if (selectedStores.has(storeName)) {
                selectedStores.delete(storeName);
                applySelectionVisual(storeName);
            } else {
                selectedStores.add(storeName);
                applySelectionVisual(storeName);
            }
            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = `${selectedStores.size} mağaza seçildi.`;
            }

            // YENİ: Seçim değiştiğinde tarih listesini güncelle
            updateBulkDeleteDateSelect();
        }

        // Tüm seçimleri temizle
        function clearAllSelections() {
            // ÖNEMLİ: önce listeyi al, set'i temizle, sonra ikonları güncelle (yoksa seçili sayılır ve halka kalır)
            const toClear = Array.from(selectedStores);
            selectedStores.clear();
            toClear.forEach(storeName => {
                applySelectionVisual(storeName);
            });
            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = "0 mağaza seçildi.";
            }

            // Modları kapat
            multiSelectMode = false;

            // Kare seçim modunu durdur
            stopRectangleSelection();

            updateSelectionModeInfo();
        }

        // Seçim modu bilgisini güncelle
        function updateSelectionModeInfo() {
            const infoDiv = document.getElementById('selectionModeInfo');
            const modeText = document.getElementById('currentModeText');

            if (!infoDiv || !modeText) return;

            if (multiSelectMode) {
                infoDiv.style.display = 'block';
                modeText.textContent = 'Toplu Seçim Modu - Mağazalara tıklayarak seçim yapın';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        function handleFreeRouteSelection(storeName, marker) {
            // Aynı noktayı tekrar eklemeyi engelle
            if (selectedRoutePoints.some(p => p.name === storeName)) {
                updateCtrlRoutePopup();
                return;
            }
            const point = { name: storeName, latlng: marker.getLatLng() };
            selectedRoutePoints.push(point);
            const orderIcon = L.divIcon({ className: 'route-order-icon', html: selectedRoutePoints.length });
            L.marker(point.latlng, { icon: orderIcon, interactive: false }).addTo(freeRouteSelectionLayer);
            updateCtrlRoutePopup();
        }

        function clearFreeRouteSelection() {
            selectedRoutePoints = [];
            try { freeRouteSelectionLayer.clearLayers(); } catch (e) { }
            hideCtrlRoutePopup();
        }

        function clearCtrlRouteSession() {
            try { clearFreeRouteSelection(); } catch (e) { }
            try { ctrlRouteLayer.clearLayers(); } catch (e) { }
        }

        function isCtrlSelectionActive(evt) {
            const oe = evt?.originalEvent;
            const modifier = oe ? (oe.ctrlKey || oe.metaKey) : false;
            return ctrlKeyDown || modifier;
        }

        function hideCtrlRoutePopup() {
            if (ctrlRoutePopup) {
                try { map.closePopup(ctrlRoutePopup); } catch (e) { }
                ctrlRoutePopup = null;
            }
        }

        function updateCtrlRoutePopup() {
            if (selectedRoutePoints.length < 2) {
                hideCtrlRoutePopup();
                return;
            }
            const last = selectedRoutePoints[selectedRoutePoints.length - 1];
            const html = `
            <div class="ctrl-route-actions">
                <button class="ctrl-route-btn primary" onclick="window.ctrlRouteCalculate(); return false;">Seçimi Hesapla</button>
            </div>
        `;
            if (!ctrlRoutePopup) {
                ctrlRoutePopup = L.popup({
                    closeButton: false,
                    autoClose: false,
                    closeOnClick: false,
                    className: 'ctrl-route-popup',
                    // Marker'ın biraz daha üstünde, ortalı görünmesi için
                    offset: [0, -40],
                    maxWidth: 260,
                    minWidth: 0
                });
            }
            ctrlRoutePopup.setLatLng(last.latlng).setContent(html);
            ctrlRoutePopup.openOn(map);
        }

        window.ctrlRouteCalculate = function () {
            if (selectedRoutePoints.length < 2) {
                alert("Rota çizmek için en az 2 nokta seçmeliniz.");
                return;
            }
            try { ctrlRouteLayer.clearLayers(); } catch (e) { }
            const points = selectedRoutePoints.map(p => ({ lat: p.latlng.lat, lon: p.latlng.lng }));
            calculateAndDrawRoute(points, 'red', 0, ctrlRouteLayer);
            updateCtrlRoutePopup();
        };

        function bulkAssignHandler() {
            const dateToAssignInput = document.getElementById("bulkDateInput")?.value.trim();
            const merchToAssign = document.getElementById("bulkMerchInput")?.value;
            if (!dateToAssignInput && !merchToAssign) {
                alert("Lütfen atanacak bir gün veya personel seçin.");
                return;
            }
            if (selectedStores.size === 0) {
                alert("Lütfen en az bir mağaza seçin.");
                return;
            }

            let dateToAssign = null;
            if (dateToAssignInput) {
                if (!isValidDate(dateToAssignInput)) {
                    alert("Lütfen 1-28 arası geçerli bir gün girin (Pazar günleri planlanmaz).");
                    return;
                }
                dateToAssign = convertDateFormat(dateToAssignInput);
            }

            // Eğer gün veya personel değiştiriliyorsa, eski dailyOrder'dan seçilen mağazaları çıkar
            const storesToProcess = Array.from(selectedStores);

            // Önce eski dailyOrder'dan seçilen mağazaları çıkar (tüm günlerden ve personellerden)
            if (dateToAssign || merchToAssign) {
                for (const date in dailyOrder) {
                    for (const merch in dailyOrder[date]) {
                        const storesInGroup = dailyOrder[date][merch] || [];
                        storesToProcess.forEach(storeName => {
                            const index = storesInGroup.indexOf(storeName);
                            if (index !== -1) {
                                storesInGroup.splice(index, 1);
                            }
                        });
                        // Eğer grup boşaldıysa temizle
                        if (storesInGroup.length === 0) {
                            delete dailyOrder[date][merch];
                            if (Object.keys(dailyOrder[date]).length === 0) {
                                delete dailyOrder[date];
                            }
                        }
                    }
                }
            }

            let merchWasUpdated = false;
            storesToProcess.forEach(storeName => {
                // Personel güncelle
                if (merchToAssign) {
                    const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                    if (store) {
                        store.Personel = merchToAssign;
                        editedStores[storeName] = editedStores[storeName] || {};
                        editedStores[storeName].Personel = merchToAssign;
                        merchWasUpdated = true;
                    }
                }

                // Gün güncelle: YENİ GÜNÜ EKLE, ESKİ GÜNLERİ SİLME
                if (dateToAssign) {
                    // Mevcut günleri koru, yeni günü ekle (eğer yoksa)
                    if (!schedule[storeName]) {
                        schedule[storeName] = [];
                    }
                    // Yeni günü ekle (eğer zaten yoksa)
                    if (!schedule[storeName].includes(dateToAssign)) {
                        schedule[storeName].push(dateToAssign);
                    }

                    // DailyOrder'a yeni personel ve gün ile ekle
                    const finalMerch = merchToAssign || stores.find(s => s['Mağaza İsmi'] === storeName)?.Personel || 'Belirtilmemiş';
                    if (!dailyOrder[dateToAssign]) {
                        dailyOrder[dateToAssign] = {};
                    }
                    if (!dailyOrder[dateToAssign][finalMerch]) {
                        dailyOrder[dateToAssign][finalMerch] = [];
                    }
                    if (!dailyOrder[dateToAssign][finalMerch].includes(storeName)) {
                        dailyOrder[dateToAssign][finalMerch].push(storeName);
                    }
                } else if (merchToAssign) {
                    // Sadece personel değiştiriliyorsa, mevcut günleri koru ama dailyOrder'ı güncelle
                    const currentDates = schedule[storeName] || [];
                    const finalMerch = merchToAssign;

                    // Eski personel ile dailyOrder'dan çıkar (yukarıda zaten çıkarıldı)
                    // Yeni personel ile ekle
                    currentDates.forEach(date => {
                        if (!dailyOrder[date]) {
                            dailyOrder[date] = {};
                        }
                        if (!dailyOrder[date][finalMerch]) {
                            dailyOrder[date][finalMerch] = [];
                        }
                        if (!dailyOrder[date][finalMerch].includes(storeName)) {
                            dailyOrder[date][finalMerch].push(storeName);
                        }
                    });
                }

                updateStoreAppearanceAndLists(storeName);
            });

            if (merchWasUpdated) {
                populateMerchFilter();
                updateMerchNumberMap();
                populateBulkMerchSelect();
                updateAllMarkersAppearance();
            }

            let alertMessage = `${selectedStores.size} mağazaya atama yapıldı:`;
            if (dateToAssignInput) alertMessage += `\n- Gün: ${dateToAssignInput}`;
            if (merchToAssign) alertMessage += `\n- Personel: ${merchToAssign}`;
            alert(alertMessage);

            // Seçimleri temizle
            clearAllSelections();
        }

        function bulkClearDatesHandler() {
            if (selectedStores.size === 0) {
                alert("Lütfen en az bir mağaza seçin.");
                return;
            }
            if (confirm(`${selectedStores.size} mağazanın tüm gün atamalarını temizlemek istediğinizden emin misiniz?`)) {
                selectedStores.forEach(storeName => {
                    delete schedule[storeName];
                    updateStoreAppearanceAndLists(storeName);
                });
                alert("Seçilen mağazaların gün atamaları temizlendi.");

                // Seçimleri temizle
                clearAllSelections();
            }
        }

        // YENİ: Seçilen mağazaların tarihlerini dropdown'a doldur
        function updateBulkDeleteDateSelect() {
            const select = document.getElementById('bulkDeleteDateSelect');
            const btn = document.getElementById('bulkDeleteSpecificDateBtn');

            if (!select || !btn) return;

            // Mevcut seçenekleri temizle
            select.innerHTML = '<option value="">Silinecek Günü Seçiniz</option>';

            if (selectedStores.size === 0) {
                btn.disabled = true;
                return;
            }

            const allDates = new Set();
            selectedStores.forEach(storeName => {
                const dates = schedule[storeName] || [];
                dates.forEach(d => allDates.add(d));
            });

            if (allDates.size === 0) {
                const option = new Option("Mağazalarda gün yok", "");
                select.add(option);
                btn.disabled = true;
            } else {
                // Tarihleri sırala ve ekle
                Array.from(allDates).sort(compareDates).forEach(date => {
                    select.add(new Option(date, date));
                });
                btn.disabled = false;
            }
        }

        // YENİ: Seçili tarihi silme işlemi
        function bulkDeleteSpecificDateHandler() {
            const dateToDelete = document.getElementById('bulkDeleteDateSelect').value;
            if (!dateToDelete) {
                alert("Lütfen silinecek günü listeden seçin.");
                return;
            }

            if (selectedStores.size === 0) {
                alert("Lütfen en az bir mağaza seçin.");
                return;
            }

            if (!confirm(`${selectedStores.size} mağaza içinden '${dateToDelete}' gününü silmek istediğinizden emin misiniz?`)) {
                return;
            }

            let updatedCount = 0;
            selectedStores.forEach(storeName => {
                if (schedule[storeName]) {
                    const originalLength = schedule[storeName].length;
                    // Sadece seçilen tarihi filtrele
                    schedule[storeName] = schedule[storeName].filter(d => d !== dateToDelete);

                    // Eğer değişiklik olduysa sayacı artır ve görünümü güncelle
                    if (schedule[storeName].length < originalLength) {
                        updatedCount++;
                        // Eğer hiç tarih kalmadıysa kaydı sil
                        if (schedule[storeName].length === 0) delete schedule[storeName];
                        updateStoreAppearanceAndLists(storeName);
                    }
                }
            });

            alert(`${updatedCount} mağazadan '${dateToDelete}' günü silindi.`);

            // Seçimleri temizle
            clearAllSelections();
        }

        function savePlanHandler() {
            try {
                localStorage.setItem('savedSchedule', JSON.stringify(schedule));
                localStorage.setItem('savedDailyOrder', JSON.stringify(dailyOrder));
                localStorage.setItem('savedStoreNotes', JSON.stringify(storeNotes));
                localStorage.setItem('savedStores', JSON.stringify(stores));
                localStorage.setItem('savedEmptyDays', JSON.stringify(emptyDays));
                alert('Çalışmanız başarıyla tarayıcıya kaydedildi!');
            } catch (e) {
                alert('Hata: Çalışma kaydedilemedi. Tarayıcınızda depolama alanı dolu olabilir.');
                console.error('Kaydetme hatası:', e);
            }
        }

        function clearPlanHandler() {
            if (confirm('Kaydedilmiş tüm verileri tarayıcıdan silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                localStorage.removeItem('savedSchedule');
                localStorage.removeItem('savedDailyOrder');
                localStorage.removeItem('savedStoreNotes');
                localStorage.removeItem('savedStores');
                localStorage.removeItem('savedEmptyDays');
                alert('Kaydedilmiş veriler temizlendi. Sayfayı yenileyerek sıfırdan başlayabilirsiniz.');
            }
        }

        // YENİ: Güncellenmiş downloadPlan fonksiyonu - new_stores_data ekle
        function downloadPlan(downloadType) {
            const selectedDate = document.getElementById('dateFilter')?.value || 'all';
            const selectedMerch = document.getElementById('merchFilter')?.value || 'all';
            const selectedRegion = document.getElementById('regionFilter')?.value || 'all';
            // YENİ: Yeni filtreleri al
            const selectedStore = document.getElementById('storeSearchFilter')?.value || '';
            const selectedCity = document.getElementById('cityFilter')?.value || 'all';
            const selectedDistrict = document.getElementById('districtFilter')?.value || 'all';

            // GÜNCELLEME: Filtre kontrolü - herhangi bir filtre aktifse sadece filtrelenmiş verileri indir
            const isAnyFilterActive = selectedDate !== 'all' || selectedMerch !== 'all' || selectedRegion !== 'all' ||
                selectedStore !== '' || selectedCity !== 'all' || selectedDistrict !== 'all';

            let scheduleToSend = schedule;
            let storesToSend = stores;
            let dailyOrderToSend = dailyOrder;
            let storeNotesToSend = storeNotes;
            let editedStoresToSend = editedStores;
            let newStoresToSend = stores.filter(store => store.isNew);

            // Eğer herhangi bir filtre aktifse, sadece filtrelenmiş verileri gönder
            if (isAnyFilterActive) {
                const filteredSchedule = {};
                const filteredStores = [];
                const filteredDailyOrder = {};
                const filteredStoreNotes = {};
                const filteredEditedStores = {};
                const filteredNewStores = [];

                // Filtrelenmiş mağazaları bul
                const filteredStoreNames = new Set();

                for (const storeName in schedule) {
                    const storeData = stores.find(s => s['Mağaza İsmi'] === storeName);
                    if (!storeData) continue;

                    const storeMerch = findMerchForStore(storeName);
                    const storeRegion = storeData.Bölge || "";
                    const storeCity = storeData.İl || "";
                    const storeDistrict = storeData.İlçe || "";
                    // YENİ: Yeni filtre kontrolleri
                    const storeNameMatch = !selectedStore || storeName.toLowerCase().includes(selectedStore.toLowerCase());
                    const cityMatch = (selectedCity === 'all') || (storeCity === selectedCity);
                    const districtMatch = (selectedDistrict === 'all') || (storeDistrict === selectedDistrict);

                    const regionMatch = (selectedRegion === 'all') || (storeRegion === selectedRegion);
                    const merchMatch = (selectedMerch === 'all') || (storeMerch === selectedMerch);
                    const dateMatch = selectedDate === 'all' || (schedule[storeName] && schedule[storeName].some(date => date === selectedDate));

                    if (regionMatch && merchMatch && dateMatch && storeNameMatch && cityMatch && districtMatch) {
                        filteredStoreNames.add(storeName);

                        // Filtrelenmiş schedule
                        if (schedule[storeName]) {
                            const matchingDates = schedule[storeName].filter(date => selectedDate === 'all' || date === selectedDate);
                            if (matchingDates.length > 0) {
                                filteredSchedule[storeName] = matchingDates;
                            }
                        }

                        // Filtrelenmiş stores
                        filteredStores.push(storeData);

                        // Filtrelenmiş store notes
                        if (storeNotes[storeName]) {
                            filteredStoreNotes[storeName] = storeNotes[storeName];
                        }

                        // Filtrelenmiş edited stores
                        if (editedStores[storeName]) {
                            filteredEditedStores[storeName] = editedStores[storeName];
                        }

                        // Filtrelenmiş new stores
                        if (storeData.isNew) {
                            filteredNewStores.push(storeData);
                        }
                    }
                }

                // Filtrelenmiş dailyOrder
                for (const date in dailyOrder) {
                    if (selectedDate !== 'all' && date !== selectedDate) continue;

                    filteredDailyOrder[date] = {};
                    for (const merch in dailyOrder[date]) {
                        if (selectedMerch !== 'all' && merch !== selectedMerch) continue;

                        const filteredStoresForDate = dailyOrder[date][merch].filter(storeName =>
                            filteredStoreNames.has(storeName)
                        );

                        if (filteredStoresForDate.length > 0) {
                            filteredDailyOrder[date][merch] = filteredStoresForDate;
                        }
                    }

                    // Eğer bu tarih için hiç personel kalmadıysa, tarihi temizle
                    if (Object.keys(filteredDailyOrder[date]).length === 0) {
                        delete filteredDailyOrder[date];
                    }
                }

                scheduleToSend = filteredSchedule;
                storesToSend = filteredStores;
                dailyOrderToSend = filteredDailyOrder;
                storeNotesToSend = filteredStoreNotes;
                editedStoresToSend = filteredEditedStores;
                newStoresToSend = filteredNewStores;
            }

            if (Object.keys(scheduleToSend).length === 0 && Object.keys(storeNotesToSend).length === 0 &&
                Object.keys(editedStoresToSend).length === 0 && newStoresToSend.length === 0) {
                return void alert("İndirilecek herhangi bir planlama veya revize bulunmuyor. Lütfen filtreleri kontrol edin veya planlama yapın.");
            }

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/download";
            // Proje yüklüyse ve filtre yoksa proje adı + notlar gönder (413 önlenir; notlar her zaman güncel açıklama için gider)
            const useProjectFile = currentProjectName && !isAnyFilterActive;
            const formData = useProjectFile
                ? {
                    'download_type': downloadType,
                    'project_name': currentProjectName,
                    'notes_data': JSON.stringify(storeNotesToSend)
                }
                : {
                    'download_type': downloadType,
                    'schedule_data': JSON.stringify(scheduleToSend),
                    'daily_order': JSON.stringify(dailyOrderToSend),
                    'notes_data': JSON.stringify(storeNotesToSend),
                    'edited_stores_data': JSON.stringify(editedStoresToSend),
                    'new_stores_data': JSON.stringify(newStoresToSend),
                    'stores_data': JSON.stringify(storesToSend)
                };
            for (const key in formData) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = key;
                input.value = formData[key];
                form.appendChild(input);
            }
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // YENİ: TÜM GÜNLERİ OTOMATİK SIRALAMA FONKSİYONU
        async function autoSortAllDays() {
            const button = document.getElementById('autoSortAllDaysBtn');
            const progressInfo = document.getElementById('sortProgressInfo');
            const progressText = document.getElementById('sortProgressText');

            if (!button || !progressInfo || !progressText) return;

            // Butonu devre dışı bırak ve ilerleme bilgisini göster
            button.disabled = true;
            button.textContent = 'Sıralanıyor...';
            progressInfo.style.display = 'block';

            try {
                // Tüm günleri ve personelleri al
                const dates = Object.keys(dailyOrder);
                let totalGroups = 0;
                let processedGroups = 0;

                // Toplam grup sayısını hesapla
                for (const date of dates) {
                    totalGroups += Object.keys(dailyOrder[date]).length;
                }

                progressText.textContent = `Toplam ${totalGroups} grup işlenecek...`;

                // Her gün ve personel için sıralama yap
                for (const date of dates) {
                    const merchs = Object.keys(dailyOrder[date]);

                    for (const merch of merchs) {
                        processedGroups++;
                        progressText.textContent = `${processedGroups}/${totalGroups} grup işlendi (${date} - P.${merch})`;

                        const storeList = dailyOrder[date][merch];
                        if (storeList.length < 2) continue; // Sıralama için en az 2 mağaza gerekli

                        // Mağaza koordinatlarını topla
                        const points = [];
                        for (const storeName of storeList) {
                            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                            if (store) {
                                const latVal = parseCoordinate(store.Enlem);
                                const lngVal = parseCoordinate(store.Boylam);
                                if (latVal === null || lngVal === null) continue;
                                points.push({
                                    name: storeName,
                                    lat: latVal,
                                    lng: lngVal
                                });
                            }
                        }

                        if (points.length < 2) continue;

                        // En kısa rota sıralamasını hesapla
                        const sortedPoints = await calculateShortestRoute(points);

                        if (sortedPoints.length > 0) {
                            // Sıralanmış mağaza isimlerini al
                            const sortedStoreNames = sortedPoints.map(p => p.name);

                            // DailyOrder'i güncelle
                            dailyOrder[date][merch] = sortedStoreNames;
                        }

                        // API isteklerini yavaşlatmak için kısa bir bekleme
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // Schedule listesini güncelle
                updateScheduleList();

                progressText.textContent = `Tüm ${processedGroups} grup başarıyla sıralandı!`;
                setTimeout(() => {
                    progressInfo.style.display = 'none';
                    button.disabled = false;
                    button.textContent = 'Tüm Günleri Otomatik Sırala';
                }, 2000);

            } catch (error) {
                console.error('Otomatik sıralama hatası:', error);
                progressText.textContent = 'Hata oluştu: ' + error.message;
                button.disabled = false;
                button.textContent = 'Tüm Günleri Otomatik Sırala';
            }
        }

        // YENİ: EN KISA ROTA SIRALAMA FONKSİYONU (TSP - Gezgin Satıcı Problemi)
        async function calculateShortestRoute(points) {
            if (points.length < 2) return points;

            // En yakın komşu algoritması kullanarak sıralama
            const unvisited = [...points];
            const route = [];

            // Başlangıç noktası olarak ilk noktayı seç
            let currentPoint = unvisited.shift();
            route.push(currentPoint);

            while (unvisited.length > 0) {
                let nearestPoint = null;
                let shortestDistance = Infinity;

                // En yakın noktayı bul
                for (const point of unvisited) {
                    const distance = await getRouteDistance(currentPoint, point);
                    if (distance < shortestDistance) {
                        shortestDistance = distance;
                        nearestPoint = point;
                    }
                }

                if (nearestPoint) {
                    // En yakın noktayı route'a ekle ve listeden çıkar
                    route.push(nearestPoint);
                    unvisited.splice(unvisited.indexOf(nearestPoint), 1);
                    currentPoint = nearestPoint;
                } else {
                    break;
                }
            }

            return route;
        }

        // YENİ: İKİ NOKTA ARASI MESAFE HESAPLAMA FONKSİYONU
        async function getRouteDistance(pointA, pointB) {
            try {
                const response = await fetch('/get_route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: { lat: pointA.lat, lng: pointA.lng },
                        end: { lat: pointB.lat, lng: pointB.lng }
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    // Mesafeyi kilometre cinsinden döndür
                    return data.km;
                } else {
                    console.error('Rota hesaplanamadı:', data.message);
                    return Infinity;
                }
            } catch (error) {
                console.error('Mesafe hesaplama hatası:', error);
                return Infinity;
            }
        }

        // YENİ: HAVERSINE MESAFE HESAPLAMA (Kuş uçuşu mesafe)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Dünya yarıçapı (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // YENİ: GÜNLERDEKİ NOKTALARI SABİTLE
        async function fixDayStores() {
            if (Object.keys(dailyOrder).length === 0) {
                alert('Planlanmış gün bulunamadı!');
                return;
            }

            if (!confirm('Günlerdeki sapan mağazaları düzeltmek istediğinizden emin misiniz? Bu işlem mağazaların günlerini değiştirebilir.')) {
                return;
            }

            const button = document.getElementById('fixDayStoresBtn');
            button.disabled = true;
            button.textContent = 'İşleniyor...';

            try {
                let totalMoved = 0;
                const dates = Object.keys(dailyOrder).sort(compareDates);

                // Her gün için işlem yap
                for (const date of dates) {
                    const merchs = Object.keys(dailyOrder[date]);

                    for (const merch of merchs) {
                        const storeList = dailyOrder[date][merch];
                        if (storeList.length < 3) continue; // En az 3 mağaza olmalı ki outlier tespiti yapılabilsin

                        // Mağaza koordinatlarını topla
                        const storesWithCoords = [];
                        for (const storeName of storeList) {
                            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                            if (store) {
                                const latVal = parseCoordinate(store.Enlem);
                                const lngVal = parseCoordinate(store.Boylam);
                                if (latVal !== null && lngVal !== null) {
                                    storesWithCoords.push({
                                        name: storeName,
                                        lat: latVal,
                                        lng: lngVal
                                    });
                                }
                            }
                        }

                        if (storesWithCoords.length < 3) continue;

                        // Grubun merkez noktasını hesapla
                        const centerLat = storesWithCoords.reduce((sum, s) => sum + s.lat, 0) / storesWithCoords.length;
                        const centerLon = storesWithCoords.reduce((sum, s) => sum + s.lng, 0) / storesWithCoords.length;

                        // Her mağazadan merkeze olan mesafeleri hesapla
                        const distances = storesWithCoords.map(s => ({
                            ...s,
                            distance: haversineDistance(centerLat, centerLon, s.lat, s.lng)
                        }));

                        // Ortalama mesafe ve standart sapmayı hesapla
                        const avgDistance = distances.reduce((sum, d) => sum + d.distance, 0) / distances.length;
                        const variance = distances.reduce((sum, d) => sum + Math.pow(d.distance - avgDistance, 2), 0) / distances.length;
                        const stdDev = Math.sqrt(variance);

                        // Outlier'ları tespit et (ortalama + 2*standart sapma'dan uzak olanlar)
                        const threshold = avgDistance + (2 * stdDev);
                        const outliers = distances.filter(d => d.distance > threshold);

                        // Outlier'ları en yakın uygun güne taşı
                        for (const outlier of outliers) {
                            // Diğer günlerdeki mağaza gruplarını kontrol et
                            let bestDate = null;
                            let bestMerch = null;
                            let minDistance = Infinity;

                            for (const otherDate of dates) {
                                const otherMerchs = Object.keys(dailyOrder[otherDate]);

                                for (const otherMerch of otherMerchs) {
                                    // Aynı günü atla
                                    if (otherDate === date && otherMerch === merch) continue;

                                    const otherStoreList = dailyOrder[otherDate][otherMerch];
                                    if (otherStoreList.length === 0) continue;

                                    // Diğer grubun merkez noktasını hesapla
                                    const otherStoresWithCoords = [];
                                    for (const otherStoreName of otherStoreList) {
                                        const otherStore = stores.find(s => s['Mağaza İsmi'] === otherStoreName);
                                        if (otherStore) {
                                            const latVal = parseCoordinate(otherStore.Enlem);
                                            const lngVal = parseCoordinate(otherStore.Boylam);
                                            if (latVal !== null && lngVal !== null) {
                                                otherStoresWithCoords.push({ lat: latVal, lng: lngVal });
                                            }
                                        }
                                    }

                                    if (otherStoresWithCoords.length === 0) continue;

                                    const otherCenterLat = otherStoresWithCoords.reduce((sum, s) => sum + s.lat, 0) / otherStoresWithCoords.length;
                                    const otherCenterLon = otherStoresWithCoords.reduce((sum, s) => sum + s.lng, 0) / otherStoresWithCoords.length;

                                    // Outlier'dan diğer grubun merkezine mesafe
                                    const distance = haversineDistance(outlier.lat, outlier.lng, otherCenterLat, otherCenterLon);

                                    if (distance < minDistance) {
                                        minDistance = distance;
                                        bestDate = otherDate;
                                        bestMerch = otherMerch;
                                    }
                                }
                            }

                            // Eğer daha iyi bir grup bulunduysa taşı
                            if (bestDate && minDistance < threshold) {
                                // Mağazayı eski günden çıkar
                                dailyOrder[date][merch] = dailyOrder[date][merch].filter(name => name !== outlier.name);
                                if (dailyOrder[date][merch].length === 0) {
                                    delete dailyOrder[date][merch];
                                    if (Object.keys(dailyOrder[date]).length === 0) {
                                        delete dailyOrder[date];
                                    }
                                }

                                // Schedule'dan eski tarihi çıkar
                                if (schedule[outlier.name]) {
                                    schedule[outlier.name] = schedule[outlier.name].filter(d => d !== date);
                                }

                                // Yeni güne ekle
                                if (!dailyOrder[bestDate]) {
                                    dailyOrder[bestDate] = {};
                                }
                                if (!dailyOrder[bestDate][bestMerch]) {
                                    dailyOrder[bestDate][bestMerch] = [];
                                }
                                if (!dailyOrder[bestDate][bestMerch].includes(outlier.name)) {
                                    dailyOrder[bestDate][bestMerch].push(outlier.name);
                                }

                                // Schedule'a yeni tarihi ekle
                                if (!schedule[outlier.name]) {
                                    schedule[outlier.name] = [];
                                }
                                if (!schedule[outlier.name].includes(bestDate)) {
                                    schedule[outlier.name].push(bestDate);
                                }

                                totalMoved++;
                            }
                        }
                    }
                }

                // Tüm günlerdeki mağazaları en yakın komşu algoritması ile yeniden sırala
                for (const date of Object.keys(dailyOrder)) {
                    const merchs = Object.keys(dailyOrder[date]);

                    for (const merch of merchs) {
                        const storeList = dailyOrder[date][merch];
                        if (storeList.length < 2) continue;

                        const storesWithCoords = [];
                        for (const storeName of storeList) {
                            const store = stores.find(s => s['Mağaza İsmi'] === storeName);
                            if (store) {
                                const latVal = parseCoordinate(store.Enlem);
                                const lngVal = parseCoordinate(store.Boylam);
                                if (latVal !== null && lngVal !== null) {
                                    storesWithCoords.push({
                                        name: storeName,
                                        lat: latVal,
                                        lng: lngVal
                                    });
                                }
                            }
                        }

                        if (storesWithCoords.length < 2) continue;

                        // En yakın komşu ile sırala
                        const sortedStores = await sortStoresByNearestNeighbor(storesWithCoords);
                        dailyOrder[date][merch] = sortedStores.map(s => s.name);
                    }
                }

                // Marker'ları güncelle
                updateAllMarkersAppearance();
                applyAllFilters();

                alert(`${totalMoved} mağaza daha uygun günlere taşındı ve tüm günler yeniden sıralandı.`);
            } catch (error) {
                console.error('Günlerdeki noktaları sabitleme hatası:', error);
                alert('Hata oluştu: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Günlerdeki Noktaları Sabitle';
            }
        }

        // YENİ: EN YAKIN KOMŞU İLE SIRALAMA
        async function sortStoresByNearestNeighbor(storesWithCoords) {
            if (storesWithCoords.length < 2) return storesWithCoords;

            const unvisited = [...storesWithCoords];
            const sorted = [];

            // Başlangıç noktası olarak ilk noktayı seç
            let current = unvisited.shift();
            sorted.push(current);

            while (unvisited.length > 0) {
                let nearest = null;
                let minDist = Infinity;

                for (const store of unvisited) {
                    const dist = haversineDistance(current.lat, current.lng, store.lat, store.lng);
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = store;
                    }
                }

                if (nearest) {
                    sorted.push(nearest);
                    unvisited.splice(unvisited.indexOf(nearest), 1);
                    current = nearest;
                } else {
                    break;
                }
            }

            return sorted;
        }

        // Mağazaları haritaya ekle
        if (stores && stores.length > 0) {
            updateMerchNumberMap();
            populateBulkMerchSelect();

            stores.forEach(store => {
                const lat = parseCoordinate(store.Enlem), lng = parseCoordinate(store.Boylam);
                if (lat !== null && lng !== null) {
                    const initialDates = schedule[store['Mağaza İsmi']] || [];
                    let initialColor = '#808080'; // Varsayılan gri renk
                    if (initialDates.length > 0) {
                        initialColor = getAppearanceForDate(initialDates[0]).markerColor; // YENİ: markerColor kullanılıyor
                    }
                    const merchNumber = findMerchForStore(store['Mağaza İsmi']);
                    const initialIcon = createMerchIcon(initialColor, merchNumber, store['Mağaza İsmi']);
                    const marker = L.marker([lat, lng], { icon: initialIcon });
                    marker.bindPopup(createPopupContent(store['Mağaza İsmi']));
                    enablePopupOnDoubleClick(marker);
                    marker.on("popupopen", e => fetchAddress(lat, lng, e.popup));
                    marker.on("click", (e) => {
                        if (isCtrlSelectionActive(e)) {
                            try {
                                if (e?.originalEvent) {
                                    e.originalEvent.preventDefault();
                                    e.originalEvent.stopPropagation();
                                }
                            } catch (err) { }
                            handleFreeRouteSelection(store['Mağaza İsmi'], marker);
                            return;
                        }
                        if (multiSelectMode) {
                            handleMultiSelect(store['Mağaza İsmi']);
                        }
                    });
                    markers[store['Mağaza İsmi']] = marker;

                    // YENİ: Mağaza ismi etiketini ekle
                    updateStoreNameLabel(store['Mağaza İsmi']);
                }
            });
            populateFilters();
            applyAllFilters();
            setTimeout(() => {
                if (markerClusterGroup.getLayers().length > 0) {
                    map.fitBounds(markerClusterGroup.getBounds(), { padding: [50, 50] });
                } else if (nonClusteredGroup.getLayers().length > 0) {
                    map.fitBounds(nonClusteredGroup.getBounds(), { padding: [50, 50] });
                }
            }, 200);
        }

        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        const existingDrawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems, remove: true },
            draw: {
                polygon: false,
                polyline: { shapeOptions: { color: "blue" } },
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(existingDrawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            const type = e.layerType;
            const layer = e.layer;

            if (type === 'polyline') {
                drawnItems.addLayer(layer);
                const latlngs = layer.getLatLngs();
                if (latlngs.length >= 2) {
                    fetch("/get_route", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ start: latlngs[0], end: latlngs[latlngs.length - 1] })
                    }).then(res => res.json()).then(data => {
                        if (data.status === "success") {
                            layer.bindPopup(`<b>Mesafe:</b> ${data.km} km<br><b>Süre:</b> ${data.min} dakika`).openPopup();
                        } else {
                            alert("Rota hesaplanamadı: " + data.message);
                        }
                    }).catch(err => {
                        console.error("Rota hesaplama hatası:", err);
                        alert("Rota hesaplanamadı.");
                    });
                }
            }
        });
    </script>
</body>

</html>

</html>